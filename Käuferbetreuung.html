<!DOCTYPE html><html lang="de"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√§uferbetreuung ‚Äì √úberbauung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&amp;family=Plus+Jakarta+Sans:wght@500;600;700&amp;display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                        num: ['Plus Jakarta Sans', 'DM Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent: #0d9488;
            --accent-light: #ccfbf1;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --premium: #7c3aed;
            --premium-light: #f3e8ff;
        }
        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent: #14b8a6;
            --accent-light: #134e4a;
            --warning-light: #451a03;
            --danger-light: #450a0a;
            --premium-light: #4c1d95;
        }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); }
        .num { font-family: 'Plus Jakarta Sans', 'DM Sans', sans-serif; font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); }
        .input-field { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .input-field:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15); }
        .input-field:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-active { border-bottom: 3px solid var(--accent); color: var(--accent) !important; }
        .table-header { background: var(--bg-tertiary); }
        .over-budget { background: var(--danger-light); }
        .in-budget { background: var(--accent-light); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); }
        .btn-secondary:hover { filter: brightness(0.95); }
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; }
        .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .info-box { background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg-tertiary) 100%); border-left: 4px solid var(--accent); }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="card rounded-xl p-6 w-full max-w-md animate-fade-in">
            <h2 class="text-xl font-bold mb-4 text-center">üîê Anmeldung</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Benutzername</label>
                        <input type="text" id="login-username" required="" class="input-field w-full px-4 py-3 rounded-lg text-base" placeholder="Benutzername">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Passwort</label>
                        <input type="password" id="login-password" required="" class="input-field w-full px-4 py-3 rounded-lg text-base" placeholder="Passwort">
                    </div>
                    <div id="login-error" class="hidden text-sm p-3 rounded-lg" style="background: var(--danger-light); color: var(--danger)"></div>
                    <button type="submit" id="login-submit" class="w-full btn-primary py-3 rounded-lg font-medium">Anmelden</button>
                </div>
            </form>
            <p class="text-xs text-center mt-4" style="color: var(--text-muted)">
                Ohne Login: Nur Konfigurator verf√ºgbar
            </p>
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-2xl" style="color: var(--text-muted)">√ó</button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">
                        <span style="color: var(--accent)">‚óÜ</span> K√§uferbetreuung
                    </h1>
                    <p class="text-sm mt-1" style="color: var(--text-secondary)">√úberbauung ¬∑ Wohnungen, DEFH &amp; EFH</p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Auth-abh√§ngige Buttons -->
                    <div id="auth-buttons-logged-out" class="flex items-center gap-2">
                        <button onclick="showLoginModal()" class="px-3 py-2 rounded-lg text-sm font-medium btn-primary">üîê Login</button>
                    </div>
                    <div id="auth-buttons-logged-in" class="hidden flex items-center gap-2">
                        <button onclick="exportData()" class="px-3 py-2 rounded-lg text-sm font-medium btn-secondary auth-required">üì§ Export</button>
                        <button onclick="showImportModal()" class="px-3 py-2 rounded-lg text-sm font-medium btn-secondary auth-required admin-only">üì• Import</button>
                        <button onclick="exportForKonfigurator()" class="px-3 py-2 rounded-lg text-sm font-medium auth-required" style="background: var(--premium-light); color: var(--premium)">üåü Konfigurator-Export</button>
                        <span id="current-user" class="text-sm px-3 py-1 rounded-full" style="background: var(--accent-light); color: var(--accent)"></span>
                        <button onclick="handleLogout()" class="px-3 py-2 rounded-lg text-sm font-medium btn-secondary">üö™ Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Info Box (nur f√ºr eingeloggte User) -->
        <div id="info-box" class="info-box rounded-lg p-4 mb-6 auth-required hidden">
            <p class="text-sm" style="color: var(--text-secondary)">
                <strong>Workflow:</strong> 1Ô∏è‚É£ Einheiten per CSV importieren (Stammdaten, m¬≤, CHF/m¬≤) ‚Üí
                2Ô∏è‚É£ Im K√§ufer-Tab: K√§ufer zuweisen + Auswahl erfassen ‚Üí
                3Ô∏è‚É£ Reports generieren
            </p>
        </div>

        <!-- Navigation Tabs -->
        <nav id="main-nav" class="flex flex-wrap border-b mb-6" style="border-color: var(--border-color)">
            <button onclick="switchTab('settings')" id="tab-settings" class="px-4 py-3 text-sm font-medium auth-required admin-only" style="color: var(--text-secondary)">‚öôÔ∏è Einstellungen</button>
            <button onclick="switchTab('units')" id="tab-units" class="px-4 py-3 text-sm font-medium auth-required" style="color: var(--text-secondary)">üè† Einheiten</button>
            <button onclick="switchTab('buyers')" id="tab-buyers" class="px-4 py-3 text-sm font-medium auth-required" style="color: var(--text-secondary)">üë§ K√§ufer</button>
            <button onclick="switchTab('buyer-report')" id="tab-buyer-report" class="px-4 py-3 text-sm font-medium auth-required" style="color: var(--text-secondary)">üìã K√§ufer-Report</button>
            <button onclick="switchTab('project-report')" id="tab-project-report" class="px-4 py-3 text-sm font-medium auth-required admin-only" style="color: var(--text-secondary)">üìä Projekt-Report</button>
            <span class="flex-1"></span>
            <button onclick="switchTab('configurator')" id="tab-configurator" class="px-4 py-3 text-sm font-medium tab-active" style="color: var(--premium); background: var(--premium-light); border-radius: 8px 8px 0 0;">üåü Kunden-Konfigurator</button>
        </nav>

        <main>
            <!-- Settings Tab -->
            <section id="content-settings" class="animate-fade-in space-y-6">
                <div class="card rounded-xl p-6">
                    <h2 class="text-lg font-semibold mb-4">Premium-Leistungen (CHF)</h2>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">Exklusive Leistungen f√ºr Premium-Kunden ‚Äì im Gesamtpreis inbegriffen.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Betreuungspauschale <span class="badge" style="background: #f3e8ff; color: #7c3aed">pauschal</span></label>
                            <input type="number" id="price-premium-betreuung" placeholder="z.B. 15000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="15000">
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold mb-4">Projektkosten &amp; Prognose</h2>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">Kostenprognose f√ºr Gewinnberechnung im Projekt-Report.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Kostenprognose (CHF)</label>
                            <input type="number" id="price-kostenprognose" placeholder="z.B. 50000000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="0">
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold mb-4">Kulanz-Regelung</h2>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">Budget-√úberschreitungen unter dieser Schwelle werden aus Kulanz nicht verrechnet.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Kulanz-Schwelle (CHF)</label>
                            <input type="number" id="price-kulanz-schwelle" placeholder="z.B. 500" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="0">
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold mb-4">Parkpl√§tze &amp; Nebenr√§ume (CHF)</h2>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">Pflicht-PP gem√§ss CSV + optionale Zus√§tze.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Pflicht-Parkplatz <span class="badge" style="background: #dbeafe; color: #1e40af">gem. CSV</span></label>
                            <input type="number" id="price-parkplatz" placeholder="z.B. 45000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="45000">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Zusatzparkplatz <span class="badge" style="background: #fef3c7; color: #92400e">Option</span></label>
                            <input type="number" id="price-zusatzparkplatz" placeholder="z.B. 45000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="45000">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">Bastelraum <span class="badge" style="background: #fef3c7; color: #92400e">Option</span></label>
                            <input type="number" id="price-bastelraum" placeholder="z.B. 15000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="15000">
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold mb-4">Optionspreise (CHF)</h2>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">Preise f√ºr Zusatzoptionen ‚Äì werden dem Verkaufspreis aufgerechnet.</p>
                    <div class="space-y-4">
                        <!-- W-Lan Soundsystem -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üîä W-Lan Soundsystem <span class="badge" style="background: #dbeafe; color: #1e40af">pro Zimmer</span></label>
                                    <input type="number" id="price-sonos" placeholder="z.B. 1000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="1000">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-sonos" placeholder="z.B. Vorbereitung f√ºr W-Lan Soundsystem z.B. Sonos" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Whirlpool -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üõÅ Whirlpool <span class="badge" style="background: #fef3c7; color: #92400e">nur Attika</span></label>
                                    <input type="number" id="price-whirlpool" placeholder="z.B. 25000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-whirlpool" placeholder="z.B. Luxuri√∂ser Whirlpool auf der Dachterrasse" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Chemin&eacute;e -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üî• Chemin√©e <span class="badge" style="background: #fef3c7; color: #92400e">nur Attika</span></label>
                                    <input type="number" id="price-cheminee" placeholder="z.B. 12000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-cheminee" placeholder="z.B. Gem√ºtlicher Gaskamin im Wohnbereich" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Weissputzw&auml;nde -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üé® Weissputzw√§nde <span class="badge" style="background: var(--premium-light); color: var(--premium)">Premium pro m¬≤</span></label>
                                    <input type="number" id="price-weissputz" placeholder="z.B. 45" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-weissputz" placeholder="z.B. Hochwertige Weissputzw√§nde statt Malervlies" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Blockfuttert&uuml;ren -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üö™ Blockfuttert√ºren <span class="badge" style="background: var(--premium-light); color: var(--premium)">Premium pro T√ºre</span></label>
                                    <input type="number" id="price-blockfutter" placeholder="z.B. 350" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-blockfutter" placeholder="z.B. Elegante Blockfutterzargen bei allen Innent√ºren" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Elektroinstallation -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">‚ö° Elektroinstallation <span class="badge" style="background: var(--premium-light); color: var(--premium)">Premium pro Zimmer</span></label>
                                    <input type="number" id="price-premium-elektro" placeholder="z.B. 2000" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0" value="2000">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-elektro" placeholder="z.B. Erweiterte Elektroinstallation mit zus√§tzlichen Steckdosen" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- Einbauschr&auml;nke -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üóÑÔ∏è Einbauschr√§nke <span class="badge" style="background: #dbeafe; color: #1e40af">Option pro m'</span></label>
                                    <input type="number" id="price-einbauschrank" placeholder="z.B. 800" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-einbauschrank" placeholder="z.B. Massgeschneiderte Einbauschr√§nke nach Wunsch" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                        <!-- E-Ladestation -->
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary)">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üîå E-Ladestation TG <span class="badge" style="background: #dbeafe; color: #1e40af">Option pro St√ºck</span></label>
                                    <input type="number" id="price-eladestation" placeholder="z.B. 3500" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary)">üìù Beschreibung (Tooltip)</label>
                                    <input type="text" id="desc-eladestation" placeholder="z.B. Ladestation f√ºr Elektrofahrzeuge in der Tiefgarage" class="input-field w-full px-3 py-2 rounded-lg text-base" maxlength="200">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <button onclick="showSettingsCsvImportModal()" class="px-4 py-2 rounded-lg text-sm font-medium border" style="border-color: var(--border-color); color: var(--text-secondary)">üìÑ CSV Import</button>
                        <button onclick="saveSettings()" class="btn-primary px-5 py-2 rounded-lg text-sm font-medium">‚úì Speichern</button>
                    </div>
                </div>
            </section>

            <!-- Units Tab -->
            <section id="content-units" class="hidden animate-fade-in">
                <div class="card rounded-xl p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div>
                            <h2 class="text-lg font-semibold">Einheiten-Stammdaten</h2>
                            <p class="text-sm" style="color: var(--text-muted)">Importieren Sie alle Einheiten per CSV oder erfassen Sie manuell</p>
                        </div>
                        <button onclick="showCsvImportModal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">üìÑ CSV Import</button>
                    </div>

                    <div class="overflow-x-auto scrollbar-thin">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="table-header">
                                    <th class="text-left p-3 font-medium rounded-tl-lg">ID</th>
                                    <th class="text-left p-3 font-medium">Typ</th>
                                    <th class="text-right p-3 font-medium">VP (CHF)</th>
                                    <th class="text-center p-3 font-medium">PP</th>
                                    <th class="text-right p-3 font-medium">Basic</th>
                                    <th class="text-right p-3 font-medium">Premium</th>
                                    <th class="text-center p-3 font-medium rounded-tr-lg">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="units-table-body">
                                <tr><td colspan="7" class="p-8 text-center" style="color: var(--text-muted)">Noch keine Einheiten ‚Äì bitte per CSV importieren</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p id="units-count" class="text-sm mt-3" style="color: var(--text-muted)">0 Einheiten</p>
                </div>
            </section>

            <!-- Buyers Tab -->
            <section id="content-buyers" class="hidden animate-fade-in">
                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="card rounded-xl p-6">
                            <h2 class="text-lg font-semibold mb-4">K√§ufer erfassen</h2>
                            <form id="buyer-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary)">Einheit ausw√§hlen *</label>
                                    <select id="buyer-unit-select" class="input-field w-full px-3 py-2 rounded-lg text-base" onchange="onBuyerUnitChange()">
                                        <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
                                    </select>
                                </div>
                                <div id="buyer-unit-info" class="hidden p-3 rounded-lg text-sm" style="background: var(--bg-tertiary)"></div>
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary)">K√§ufername *</label>
                                    <input type="text" id="buyer-name" placeholder="Name des K√§ufers" class="input-field w-full px-3 py-2 rounded-lg text-base" required="">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary)">Ausstattungslinie *</label>
                                    <select id="buyer-line" class="input-field w-full px-3 py-2 rounded-lg text-base" onchange="onBuyerLineChange()">
                                        <option value="basic">Basic-Line (Standard)</option>
                                        <option value="premium">‚≠ê Premium (First Class)</option>
                                    </select>
                                    <div id="buyer-line-info" class="text-xs mt-2"></div>
                                </div>
                                <!-- Premium Benefits Box -->
                                <div id="premium-benefits-box" class="hidden p-4 rounded-xl" style="background: linear-gradient(135deg, var(--premium-light) 0%, rgba(124,58,237,0.1) 100%); border: 2px solid var(--premium)">
                                    <p class="text-sm font-semibold mb-2" style="color: var(--premium)">‚≠ê Premium Vorteile</p>
                                    <ul class="text-xs space-y-1" style="color: var(--text-secondary)">
                                        <li>‚úì H√∂heres Ausbaubudget f√ºr exklusive Materialien</li>
                                        <li>‚úì Pers√∂nliche K√§uferbetreuung inklusive</li>
                                        <li>‚úì Erweiterte Elektroinstallationen pro Zimmer</li>
                                        <li>‚úì Weissputzw√§nde &amp; Blockfuttert√ºren inklusive</li>
                                    </ul>
                                    <p id="premium-upgrade-price" class="text-sm font-bold mt-3 pt-2" style="color: var(--premium); border-top: 1px solid var(--premium)"></p>
                                </div>
                                <hr style="border-color: var(--border-color)">
                                <h3 class="font-medium">Auswahlkosten (CHF)</h3>
                                <p class="text-xs" style="color: var(--text-muted)">Effektive Kosten der gew√§hlten Materialien</p>
                                <div class="grid grid-cols-1 gap-3">
                                    <div>
                                        <label class="block text-xs mb-1" style="color: var(--text-muted)">Boden-/Wandbel√§ge <span id="budget-hint-boden" class="num"></span></label>
                                        <input type="number" id="buyer-cost-boden" placeholder="0" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs mb-1" style="color: var(--text-muted)">K√ºche <span id="budget-hint-kueche" class="num"></span></label>
                                        <input type="number" id="buyer-cost-kueche" placeholder="0" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs mb-1" style="color: var(--text-muted)">Sanit√§r <span id="budget-hint-sanitaer" class="num"></span></label>
                                        <input type="number" id="buyer-cost-sanitaer" placeholder="0" class="input-field w-full px-3 py-2 rounded-lg text-base num" min="0">
                                    </div>
                                </div>
                                <hr style="border-color: var(--border-color)">
                                <h3 class="font-medium">Parkpl√§tze &amp; Nebenr√§ume</h3>
                                <p class="text-xs mb-2" style="color: var(--text-muted)">Pflicht-PP gem√§ss Einheit + optionale Zus√§tze</p>
                                <div class="space-y-3 mb-4">
                                    <div class="p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm">Pflicht-Parkpl√§tze</span>
                                            <span id="buyer-pflicht-pp" class="text-sm num font-medium">0</span>
                                        </div>
                                        <p id="buyer-pflicht-pp-preis" class="text-xs num" style="color: var(--text-muted)"></p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label for="buyer-opt-zusatzpp" class="text-sm flex-1">Zusatzparkpl√§tze</label>
                                        <input type="number" id="buyer-opt-zusatzpp" min="0" value="0" class="input-field w-20 px-2 py-1 rounded text-sm num text-center">
                                        <span id="opt-price-zusatzpp" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label for="buyer-opt-bastelraum" class="text-sm flex-1">Bastelr√§ume</label>
                                        <input type="number" id="buyer-opt-bastelraum" min="0" value="0" class="input-field w-20 px-2 py-1 rounded text-sm num text-center">
                                        <span id="opt-price-bastelraum" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                    </div>
                                </div>
                                <hr style="border-color: var(--border-color)">
                                <h3 class="font-medium">Zusatzoptionen</h3>
                                <div class="space-y-2" id="buyer-options-container">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="buyer-opt-sonos" class="w-4 h-4 accent-teal-600">
                                        <label for="buyer-opt-sonos" class="text-sm flex-1">üîä Vorb. W-Lan Soundsystem</label>
                                        <span id="opt-price-sonos" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                    </div>
                                    <!-- Ausbau-Optionen (nur bei Basic w√§hlbar) -->
                                    <div id="buyer-basic-options-container" class="space-y-2 mt-2 pt-2" style="border-top: 1px dashed var(--border-color)">
                                        <p id="buyer-basic-options-label" class="text-xs font-medium">Ausbau-Optionen <span style="color: var(--text-muted)">(bei Premium inkl.)</span></p>
                                        <div id="opt-row-elektro" class="flex items-center gap-3">
                                            <input type="checkbox" id="buyer-opt-elektro" class="w-4 h-4 accent-teal-600">
                                            <label for="buyer-opt-elektro" class="text-sm flex-1">‚ö° Erweiterte Elektroinstallation <span id="buyer-zimmer-anzahl" class="text-xs" style="color: var(--text-muted)"></span></label>
                                            <span id="opt-price-elektro" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                        <div id="opt-row-weissputz" class="flex items-center gap-3">
                                            <input type="checkbox" id="buyer-opt-weissputz" class="w-4 h-4 accent-teal-600">
                                            <label for="buyer-opt-weissputz" class="text-sm flex-1">üé® Weissputzw√§nde <span id="buyer-verputz-m2" class="text-xs" style="color: var(--text-muted)"></span></label>
                                            <span id="opt-price-weissputz" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                        <div id="opt-row-blockfutter" class="flex items-center gap-3">
                                            <input type="checkbox" id="buyer-opt-blockfutter" class="w-4 h-4 accent-teal-600">
                                            <label for="buyer-opt-blockfutter" class="text-sm flex-1">üö™ Blockfuttert√ºren <span id="buyer-tueren-anzahl" class="text-xs" style="color: var(--text-muted)"></span></label>
                                            <span id="opt-price-blockfutter" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                        <div id="opt-row-einbauschrank" class="flex items-center gap-3">
                                            <div class="flex items-center gap-2 flex-1">
                                                <span class="text-sm">üóÑÔ∏è Einbauschr√§nke</span>
                                                <input type="number" id="buyer-opt-einbauschrank-lfm" min="0" step="0.5" value="0" class="input-field w-20 px-2 py-1 rounded text-center num text-sm" placeholder="m'">
                                                <span class="text-xs" style="color: var(--text-muted)">m'</span>
                                            </div>
                                            <span id="opt-price-einbauschrank" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                        <div id="opt-row-eladestation" class="flex items-center gap-3">
                                            <div class="flex items-center gap-2 flex-1">
                                                <span class="text-sm">üîå E-Ladestation TG</span>
                                                <input type="number" id="buyer-opt-eladestation" min="0" value="0" class="input-field w-20 px-2 py-1 rounded text-center num text-sm" placeholder="Anz.">
                                                <span class="text-xs" style="color: var(--text-muted)">Stk.</span>
                                            </div>
                                            <span id="opt-price-eladestation" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                    </div>
                                    <!-- Attika-Optionen immer sichtbar, aber nur f√ºr Attika w√§hlbar -->
                                    <div id="attika-options-container" class="space-y-2 mt-2 pt-2" style="border-top: 1px dashed var(--border-color)">
                                        <p id="attika-options-label" class="text-xs font-medium" style="color: var(--premium)">‚ú® Exklusiv f√ºr Attika-Wohnungen</p>
                                        <div id="opt-row-whirlpool" class="flex items-center gap-3 p-2 rounded-lg" style="background: var(--premium-light)">
                                            <input type="checkbox" id="buyer-opt-whirlpool" class="w-4 h-4 accent-purple-600" disabled="">
                                            <label for="buyer-opt-whirlpool" class="text-sm flex-1">üõÅ Whirlpool</label>
                                            <span id="opt-price-whirlpool" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                        <div id="opt-row-cheminee" class="flex items-center gap-3 p-2 rounded-lg" style="background: var(--premium-light)">
                                            <input type="checkbox" id="buyer-opt-cheminee" class="w-4 h-4 accent-purple-600" disabled="">
                                            <label for="buyer-opt-cheminee" class="text-sm flex-1">üî• Chemin√©e</label>
                                            <span id="opt-price-cheminee" class="text-sm num" style="color: var(--text-muted)">‚Äì</span>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary w-full py-3 rounded-lg font-medium mt-4">K√§ufer speichern</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card rounded-xl p-6">
                            <h2 class="text-lg font-semibold mb-4">Erfasste K√§ufer</h2>
                            <div class="overflow-x-auto scrollbar-thin">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="text-left p-3 font-medium rounded-tl-lg">Einheit</th>
                                            <th class="text-left p-3 font-medium">K√§ufer</th>
                                            <th class="text-center p-3 font-medium">Linie</th>
                                            <th class="text-right p-3 font-medium">Aufpreise</th>
                                            <th class="text-right p-3 font-medium">Gesamtpreis</th>
                                            <th class="text-center p-3 font-medium rounded-tr-lg">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="buyers-table-body">
                                        <tr><td colspan="6" class="p-8 text-center" style="color: var(--text-muted)">Noch keine K√§ufer erfasst</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Buyer Report Tab -->
            <section id="content-buyer-report" class="hidden animate-fade-in">
                <div class="card rounded-xl p-6">
                    <div class="flex items-center gap-4 mb-6">
                        <h2 class="text-lg font-semibold">K√§ufer-Report</h2>
                        <select id="report-unit-select" class="input-field px-3 py-2 rounded-lg text-base" onchange="renderBuyerReport()">
                            <option value="">‚Äì Einheit ausw√§hlen ‚Äì</option>
                        </select>
                    </div>
                    <div id="buyer-report-content">
                        <p style="color: var(--text-muted)" class="text-center py-8">Bitte w√§hlen Sie eine Einheit mit erfasstem K√§ufer</p>
                    </div>
                </div>
            </section>

            <!-- Project Report Tab -->
            <section id="content-project-report" class="hidden animate-fade-in">
                <div class="space-y-6">
                    <!-- √úbersicht Max Erl√∂s -->
                    <div class="card rounded-xl p-6" style="background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg-secondary) 100%); border-left: 4px solid var(--accent)">
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Maximaler Erl√∂s (alle Einheiten)</p>
                                <p id="stat-max-revenue" class="text-2xl font-bold num" style="color: var(--accent)">CHF 0</p>
                                <p class="text-xs mt-1" style="color: var(--text-muted)"><span id="stat-max-units">0</span> Einheiten ¬∑ <span id="stat-max-pp">0</span> PP ¬∑ <span id="stat-max-br">0</span> BR</p>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Realisierter Erl√∂s</p>
                                <p id="stat-total" class="text-2xl font-bold num" style="color: var(--accent)">CHF 0</p>
                                <p class="text-xs mt-1" style="color: var(--text-muted)"><span id="stat-buyers">0</span> verkauft ¬∑ <span id="stat-sold-percent">0</span>%</p>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Noch offen</p>
                                <p id="stat-open-revenue" class="text-2xl font-bold num" style="color: var(--warning)">CHF 0</p>
                                <p class="text-xs mt-1" style="color: var(--text-muted)"><span id="stat-open-units">0</span> Einheiten offen</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistik-Kacheln -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <div class="card rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Verkaufspreise</p>
                            <p id="stat-sales" class="text-lg font-bold num">CHF 0</p>
                        </div>
                        <div class="card rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">PP &amp; Nebenr√§ume</p>
                            <p id="stat-nebenraeume" class="text-lg font-bold num">CHF 0</p>
                        </div>
                        <div class="card rounded-xl p-4" style="background: var(--premium-light)">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--premium)">Premium-Leistungen</p>
                            <p id="stat-premium" class="text-lg font-bold num" style="color: var(--premium)">CHF 0</p>
                            <div id="stat-premium-details" class="mt-2 pt-2 text-xs space-y-1" style="border-top: 1px solid var(--border-color)"></div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Optionen</p>
                            <p id="stat-options" class="text-lg font-bold num">CHF 0</p>
                        </div>
                        <div class="card rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">√úberschreitungen</p>
                            <p id="stat-excess" class="text-lg font-bold num" style="color: var(--danger)">CHF 0</p>
                        </div>
                        <div class="card rounded-xl p-4">
                            <p class="text-xs uppercase tracking-wide mb-1" style="color: var(--text-muted)">Rundungen</p>
                            <p id="stat-rundung" class="text-lg font-bold num" style="color: var(--text-muted)">‚àíCHF 0</p>
                        </div>
                    </div>

                    <!-- Gewinnprognose & Entwicklerhonorar -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Gewinnprognose -->
                        <div class="card rounded-xl p-6" style="background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg-secondary) 100%); border-left: 4px solid var(--accent)">
                            <h3 class="text-sm font-semibold uppercase tracking-wide mb-4" style="color: var(--accent)">Gewinnprognose</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span style="color: var(--text-secondary)">Maximaler Erl√∂s</span>
                                    <span id="stat-prognose-max" class="num font-semibold">CHF 0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span style="color: var(--text-secondary)">Kostenprognose</span>
                                    <span id="stat-kostenprognose" class="num font-semibold" style="color: var(--danger)">‚àíCHF 0</span>
                                </div>
                                <div class="flex justify-between items-center pt-3" style="border-top: 2px solid var(--accent)">
                                    <span class="font-semibold" style="color: var(--accent)">Gewinn</span>
                                    <span id="stat-gewinn" class="text-xl num font-bold" style="color: var(--accent)">CHF 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Entwicklerhonorar -->
                        <div class="card rounded-xl p-6" style="background: linear-gradient(135deg, var(--warning-light) 0%, var(--bg-secondary) 100%); border-left: 4px solid var(--warning)">
                            <h3 class="text-sm font-semibold uppercase tracking-wide mb-4" style="color: var(--warning)">Entwicklerhonorar</h3>
                            <div id="entwicklerhonorar-details" class="space-y-3"></div>
                            <div class="flex justify-between items-center mt-3 pt-3" style="border-top: 2px solid var(--warning)">
                                <span class="font-semibold" style="color: var(--warning)">Total Honorar</span>
                                <span id="stat-entwicklerhonorar" class="text-xl num font-bold" style="color: var(--warning)">CHF 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-6">
                        <div class="card rounded-xl p-6">
                            <h2 class="text-lg font-semibold mb-4">Alle K√§ufer</h2>
                            <div class="overflow-x-auto scrollbar-thin">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="table-header">
                                            <th class="text-left p-3 font-medium rounded-tl-lg">Einheit</th>
                                            <th class="text-left p-3 font-medium">K√§ufer</th>
                                            <th class="text-center p-3 font-medium">Linie</th>
                                            <th class="text-right p-3 font-medium">VP</th>
                                            <th class="text-right p-3 font-medium">Aufpreise</th>
                                            <th class="text-right p-3 font-medium rounded-tr-lg">Gesamt</th>
                                        </tr>
                                    </thead>
                                    <tbody id="project-report-body">
                                        <tr><td colspan="6" class="p-4 text-center" style="color: var(--text-muted)">Keine Daten</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card rounded-xl p-6" style="background: var(--premium-light)">
                            <h2 class="text-lg font-semibold mb-4" style="color: var(--premium)">Premium-Kunden √úbersicht</h2>
                            <p class="text-sm mb-4" style="color: var(--text-muted)">Exklusive Leistungen f√ºr Premium-Kunden (interne Ansicht)</p>
                            <div id="premium-breakdown" class="space-y-3">
                                <p class="text-center py-4" style="color: var(--text-muted)">Keine Premium-K√§ufer</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Kunden-Konfigurator Tab -->
            <section id="content-configurator" class="hidden animate-fade-in">
                <div class="max-w-4xl mx-auto">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2">Ihre Traumwohnung konfigurieren</h1>
                        <p style="color: var(--text-secondary)">W√§hlen Sie Ihre Wohnung und gestalten Sie Ihren pers√∂nlichen Wohntraum</p>
                    </div>

                    <!-- Konfigurator Steps -->
                    <div class="space-y-6">
                        <!-- Step 1: Wohnung w√§hlen -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background: var(--accent)">1</span>
                                <h2 class="text-lg font-semibold">W√§hlen Sie Ihre Wohnung</h2>
                            </div>
                            <select id="config-unit-select" onchange="updateConfigurator()" class="input-field w-full px-4 py-3 rounded-lg text-lg">
                                <option value="">‚Äì Bitte Wohnung ausw√§hlen ‚Äì</option>
                            </select>
                            <div id="config-unit-info" class="hidden mt-4 p-4 rounded-lg" style="background: var(--bg-tertiary)"></div>
                        </div>

                        <!-- Step 2: Ausstattungslinie -->
                        <div id="config-step-line" class="card rounded-xl p-6 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background: var(--accent)">2</span>
                                <h2 class="text-lg font-semibold">W√§hlen Sie Ihre Ausstattungslinie</h2>
                            </div>
                            <div id="config-line-options" class="grid md:grid-cols-2 gap-4">
                                <!-- Basic Option -->
                                <div id="config-line-basic" onclick="selectConfigLine('basic')" class="config-line-card cursor-pointer p-5 rounded-xl border-2 transition-all hover:shadow-lg" style="border-color: var(--border-color)">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">üè†</span>
                                        <div>
                                            <h3 class="font-semibold">Basic-Line</h3>
                                            <p class="text-sm" style="color: var(--text-muted)">Im Verkaufspreis inbegriffen</p>
                                        </div>
                                    </div>
                                    <div id="config-basic-budgets" class="mb-3 p-3 rounded-lg text-sm" style="background: var(--bg-secondary)">
                                        <p class="text-xs font-medium mb-2" style="color: var(--text-muted)">Ihre Ausbaubudgets:</p>
                                        <div class="space-y-1">
                                            <div class="flex justify-between"><span>Boden &amp; Wand <span id="config-basic-boden-m2" class="text-xs" style="color: var(--text-muted)"></span></span><span id="config-basic-boden" class="num font-medium">‚Äì</span></div>
                                            <div class="flex justify-between"><span>K√ºche</span><span id="config-basic-kueche" class="num font-medium">‚Äì</span></div>
                                            <div class="flex justify-between"><span>Sanit√§r</span><span id="config-basic-sanitaer" class="num font-medium">‚Äì</span></div>
                                        </div>
                                    </div>
                                    <ul class="text-sm space-y-1" style="color: var(--text-secondary)">
                                        <li>‚úì Hochwertige Standardausstattung</li>
                                        <li>‚úì Qualit√§tsmaterialien</li>
                                    </ul>
                                </div>
                                <!-- Premium Option -->
                                <div id="config-line-premium" onclick="selectConfigLine('premium')" class="config-line-card cursor-pointer p-5 rounded-xl border-2 transition-all hover:shadow-lg" style="border-color: var(--border-color)">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">‚≠ê</span>
                                        <div>
                                            <h3 class="font-semibold" style="color: var(--premium)">Premium-Line</h3>
                                            <p id="config-premium-price" class="text-sm num" style="color: var(--premium)"></p>
                                        </div>
                                    </div>
                                    <div id="config-premium-budgets" class="mb-3 p-3 rounded-lg text-sm" style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); border: 1px solid var(--premium-light)">
                                        <p class="text-xs font-medium mb-2" style="color: var(--premium)">Ihre Ausbaubudgets:</p>
                                        <div class="space-y-1">
                                            <div class="flex justify-between"><span>Boden &amp; Wand <span id="config-premium-boden-m2" class="text-xs" style="color: var(--premium); opacity: 0.7"></span></span><span id="config-premium-boden" class="num font-medium" style="color: var(--premium)">‚Äì</span></div>
                                            <div class="flex justify-between"><span>K√ºche</span><span id="config-premium-kueche" class="num font-medium" style="color: var(--premium)">‚Äì</span></div>
                                            <div class="flex justify-between"><span>Sanit√§r</span><span id="config-premium-sanitaer" class="num font-medium" style="color: var(--premium)">‚Äì</span></div>
                                        </div>
                                    </div>
                                    <ul class="text-sm space-y-1" style="color: var(--text-secondary)">
                                        <li>‚úì Exklusive Materialauswahl</li>
                                        <li>‚úì Pers√∂nliche K√§uferbetreuung</li>
                                        <li>‚úì Erweiterte Elektroinstallation</li>
                                        <li>‚úì Weissputzw√§nde &amp; Blockfuttert√ºren</li>
                                    </ul>
                                </div>
                            </div>
                            <div id="config-attika-notice" class="hidden mt-4 p-4 rounded-lg" style="background: var(--premium-light); border: 1px solid var(--premium)">
                                <p class="text-sm" style="color: var(--premium)">
                                    <strong>‚≠ê Attika-Wohnung:</strong> Diese exklusive Wohnung beinhaltet automatisch die Premium-Ausstattung.
                                </p>
                            </div>
                        </div>

                        <!-- Step 3: Optionen -->
                        <div id="config-step-options" class="card rounded-xl p-6 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background: var(--accent)">3</span>
                                <h2 class="text-lg font-semibold">Zusatzoptionen</h2>
                            </div>

                            <!-- Nebenr√§ume -->
                            <div class="mb-6">
                                <h3 class="font-medium mb-3">Parkpl√§tze &amp; Nebenr√§ume</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-tertiary)">
                                        <div>
                                            <span class="font-medium">Pflicht-Parkpl√§tze</span>
                                            <span id="config-pflicht-pp" class="ml-2 badge" style="background: var(--accent-light); color: var(--accent)">0</span>
                                        </div>
                                        <span id="config-pflicht-pp-preis" class="num font-semibold"></span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-tertiary)">
                                        <div class="flex items-center gap-3">
                                            <span>Zusatz-Parkpl√§tze</span>
                                            <input type="number" id="config-zusatzpp" min="0" value="0" onchange="updateConfigPrice()" class="input-field w-20 px-2 py-1 rounded text-center num">
                                        </div>
                                        <span id="config-zusatzpp-preis" class="num" style="color: var(--text-muted)"></span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-tertiary)">
                                        <div class="flex items-center gap-3">
                                            <span>Bastelr√§ume</span>
                                            <input type="number" id="config-bastelraum" min="0" value="0" onchange="updateConfigPrice()" class="input-field w-20 px-2 py-1 rounded text-center num">
                                        </div>
                                        <span id="config-bastelraum-preis" class="num" style="color: var(--text-muted)"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Technische Optionen -->
                            <div class="mb-6">
                                <h3 class="font-medium mb-3">Technische Ausstattung</h3>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label id="config-sonos-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <input type="checkbox" id="config-opt-sonos" onchange="updateConfigPrice()" class="w-5 h-5 accent-teal-600">
                                        <div class="flex-1">
                                            <span class="font-medium">üîä Vorb. W-Lan Soundsystem</span>
                                            <p id="config-sonos-desc" class="text-xs" style="color: var(--text-muted)">z.B. Sonos</p>
                                        </div>
                                        <span id="config-sonos-preis" class="num text-sm"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Ausbau-Optionen (nur bei Basic) -->
                            <div id="config-basic-options" class="hidden mb-6">
                                <h3 class="font-medium mb-3">Ausbau-Optionen <span class="text-xs font-normal" style="color: var(--text-muted)">(bei Premium inklusive)</span></h3>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label id="config-elektro-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <input type="checkbox" id="config-opt-elektro" onchange="updateConfigPrice()" class="w-5 h-5 accent-teal-600">
                                        <div class="flex-1">
                                            <span class="font-medium">‚ö° Erweiterte Elektroinstallation</span>
                                            <p class="text-xs" style="color: var(--text-muted)">Pro Zimmer (<span id="config-zimmer-anzahl">0</span> Zimmer)</p>
                                            <p id="config-elektro-desc" class="text-xs" style="color: var(--text-muted)"></p>
                                        </div>
                                        <span id="config-elektro-preis" class="num text-sm"></span>
                                    </label>
                                    <label id="config-weissputz-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <input type="checkbox" id="config-opt-weissputz" onchange="updateConfigPrice()" class="w-5 h-5 accent-teal-600">
                                        <div class="flex-1">
                                            <span class="font-medium">üé® Weissputzw√§nde</span>
                                            <p class="text-xs" style="color: var(--text-muted)">Edle Putzoberfl√§che (<span id="config-verputz-m2">0</span> m¬≤)</p>
                                            <p id="config-weissputz-desc" class="text-xs" style="color: var(--text-muted)"></p>
                                        </div>
                                        <span id="config-weissputz-preis" class="num text-sm"></span>
                                    </label>
                                    <label id="config-blockfutter-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <input type="checkbox" id="config-opt-blockfutter" onchange="updateConfigPrice()" class="w-5 h-5 accent-teal-600">
                                        <div class="flex-1">
                                            <span class="font-medium">üö™ Blockfuttert√ºren</span>
                                            <p id="config-blockfutter-desc" class="text-xs" style="color: var(--text-muted)">Statt Stahlzargen (<span id="config-tueren-anzahl">0</span> T√ºren)</p>
                                        </div>
                                        <span id="config-blockfutter-preis" class="num text-sm"></span>
                                    </label>
                                    </div>
                            </div>

                            <!-- Zus√§tzliche Ausstattung (f√ºr Basic und Premium) -->
                            <div id="config-einbauschrank-container" class="mb-6 hidden">
                                <h3 class="font-medium mb-3">Zus√§tzliche Ausstattung</h3>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div id="config-einbauschrank-label" class="flex items-center gap-3 p-3 rounded-lg transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium">üóÑÔ∏è Einbauschr√§nke</span>
                                                <input type="number" id="config-opt-einbauschrank-lfm" min="0" step="0.5" value="0" onchange="updateConfigPrice()" oninput="updateConfigPrice()" class="input-field w-20 px-2 py-1 rounded text-center num text-sm" placeholder="m'">
                                                <span class="text-xs" style="color: var(--text-muted)">m'</span>
                                            </div>
                                            <p id="config-einbauschrank-desc" class="text-xs mt-1" style="color: var(--text-muted)"></p>
                                        </div>
                                        <span id="config-einbauschrank-preis" class="num text-sm"></span>
                                    </div>
                                    <div id="config-eladestation-label" class="flex items-center gap-3 p-3 rounded-lg transition-all hover:shadow" style="background: var(--bg-tertiary)" title="">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="font-medium">üîå E-Ladestation TG</span>
                                                <input type="number" id="config-opt-eladestation" min="0" value="0" onchange="updateConfigPrice()" oninput="updateConfigPrice()" class="input-field w-20 px-2 py-1 rounded text-center num text-sm" placeholder="Anz.">
                                                <span class="text-xs" style="color: var(--text-muted)">Stk.</span>
                                            </div>
                                            <p id="config-eladestation-desc" class="text-xs mt-1" style="color: var(--text-muted)"></p>
                                        </div>
                                        <span id="config-eladestation-preis" class="num text-sm"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Attika Optionen -->
                            <div id="config-attika-options" class="hidden">
                                <h3 class="font-medium mb-3" style="color: var(--premium)">‚ú® Exklusiv f√ºr Attika</h3>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label id="config-whirlpool-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--premium-light)" title="">
                                        <input type="checkbox" id="config-opt-whirlpool" onchange="updateConfigPrice()" class="w-5 h-5 accent-purple-600">
                                        <div class="flex-1">
                                            <span class="font-medium">üõÅ Whirlpool</span>
                                            <p id="config-whirlpool-desc" class="text-xs" style="color: var(--text-muted)">Luxuri√∂ses Wellness-Erlebnis</p>
                                        </div>
                                        <span id="config-whirlpool-preis" class="num text-sm" style="color: var(--premium)"></span>
                                    </label>
                                    <label id="config-cheminee-label" class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:shadow" style="background: var(--premium-light)" title="">
                                        <input type="checkbox" id="config-opt-cheminee" onchange="updateConfigPrice()" class="w-5 h-5 accent-purple-600">
                                        <div class="flex-1">
                                            <span class="font-medium">üî• Chemin√©e</span>
                                            <p id="config-cheminee-desc" class="text-xs" style="color: var(--text-muted)">Gem√ºtliche Atmosph√§re</p>
                                        </div>
                                        <span id="config-cheminee-preis" class="num text-sm" style="color: var(--premium)"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Preis√ºbersicht -->
                        <div id="config-step-summary" class="card rounded-xl p-6 hidden" style="background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg-secondary) 100%); border: 2px solid var(--accent)">
                            <h2 class="text-lg font-semibold mb-4">Ihre Konfiguration</h2>
                            <div id="config-summary-details" class="space-y-2 mb-4"></div>
                            <div class="flex justify-between items-center pt-4" style="border-top: 2px solid var(--accent)">
                                <span class="text-xl font-bold">Gesamtpreis</span>
                                <span id="config-total-price" class="text-3xl font-bold num" style="color: var(--accent)">CHF 0</span>
                            </div>
                            <p class="text-sm mt-2" style="color: var(--text-muted)">Preise in CHF, auf CHF 1'000 gerundet</p>
                        </div>

                        <!-- Anfrage Button -->
                        <div id="config-step-submit" class="hidden">
                            <div class="card rounded-xl p-6 text-center" style="background: var(--premium-light)">
                                <p class="mb-4" style="color: var(--text-secondary)">
                                    Mit der Reservationsanfrage wird eine <strong>Reservationszahlung von CHF 40'000</strong> f√§llig.
                                </p>
                                <button onclick="submitConfigRequest()" class="btn-primary px-8 py-4 rounded-xl text-lg font-semibold" style="background: var(--premium)">
                                    üè† Anfrage absenden
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div class="card rounded-xl p-6 max-w-lg w-full mx-4 animate-fade-in">
            <h3 class="text-lg font-semibold mb-4">JSON-Daten importieren</h3>
            <textarea id="import-data" class="input-field w-full h-48 p-3 rounded-lg num text-sm" placeholder="JSON-Daten hier einf√ºgen..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="hideImportModal()" class="px-4 py-2 rounded-lg btn-secondary">Abbrechen</button>
                <button onclick="importData()" class="btn-primary px-4 py-2 rounded-lg">Importieren</button>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="csv-import-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-backdrop">
        <div class="card rounded-xl p-6 max-w-5xl w-full mx-4 animate-fade-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">üìÑ Einheiten-Stammdaten per CSV importieren</h3>
            <div class="info-box rounded-lg p-4 mb-4">
                <p class="text-sm font-medium mb-2">CSV-Format (Semikolon-getrennt):</p>
                <code class="text-xs num block" style="color: var(--text-secondary)">
                    id;verkaufspreis;kategorie;typ;attika;zimmer;boden_m2;platten_m2;verputz_m2;tueren;basic_chf_m2;basic_kueche;basic_sanitaer;premium_chf_m2;premium_kueche;premium_sanitaer;stueckzahl;parkplaetze
                </code>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="text-sm" style="color: var(--text-secondary)">
                    <p class="font-medium mb-2">Spalten-Erkl√§rung:</p>
                    <ul class="space-y-1 text-xs">
                        <li><strong>id</strong> ‚Äì Einheit-ID Pr√§fix (z.B. W-3.5 ‚Üí W-3.5-01, W-3.5-02...)</li>
                        <li><strong>verkaufspreis</strong> ‚Äì Verkaufspreis in CHF</li>
                        <li><strong>kategorie</strong> ‚Äì wohnung, defh, efh</li>
                        <li><strong>typ</strong> ‚Äì Wohnungstyp (z.B. 3.5-Zi) oder leer</li>
                        <li><strong>attika</strong> ‚Äì ja oder nein</li>
                        <li><strong>zimmer</strong> ‚Äì Anzahl Zimmer (f√ºr KNX/Sonos-Berechnung)</li>
                        <li><strong>boden_m2, platten_m2, verputz_m2</strong> ‚Äì Quadratmeter</li>
                        <li><strong>tueren</strong> ‚Äì Anzahl T√ºren (f√ºr Blockfutter-Berechnung bei Premium)</li>
                        <li><strong>basic_chf_m2</strong> ‚Äì CHF pro m¬≤ (Basic) ‚Üí Budget = (boden+platten) √ó CHF/m¬≤</li>
                        <li><strong>basic_kueche, basic_sanitaer</strong> ‚Äì Pauschalbudgets (CHF)</li>
                        <li><strong>premium_chf_m2, premium_kueche, premium_sanitaer</strong> ‚Äì Premium-Budgets</li>
                        <li><strong>stueckzahl</strong> ‚Äì Anzahl Einheiten dieses Typs (optional, Standard: 1)</li>
                        <li><strong>parkplaetze</strong> ‚Äì Pflicht-Parkpl√§tze pro Einheit (optional)</li>
                    </ul>
                </div>
                <div class="text-sm">
                    <p class="font-medium mb-2">Beispiel:</p>
                    <div class="p-2 rounded text-xs num overflow-x-auto" style="background: var(--bg-tertiary)">
                        <pre style="color: var(--text-secondary)">id;vp;kat;typ;attika;zi;boden;platten;verputz;tueren;b_m2;b_k;b_s;p_m2;p_k;p_s;stk;pp
W-3.5;850000;wohnung;3.5-Zi;nein;3.5;65;80;40;8;80;22000;8000;120;32000;12000;8;1
W-5.5A;1350000;wohnung;5.5-Zi;ja;5.5;110;120;60;12;80;28000;10000;120;42000;16000;2;2
D;1450000;defh;;nein;6.5;140;150;70;15;85;35000;12000;130;52000;18000;4;2</pre>
                    </div>
                    <p class="text-xs mt-2" style="color: var(--text-muted)">
                        stk=St√ºckzahl ¬∑ pp=Pflicht-Parkpl√§tze ¬∑ Zusatz-PP &amp; Bastelr√§ume sind K√§ufer-Optionen
                    </p>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">CSV-Datei oder Daten einf√ºgen:</label>
                <input type="file" id="csv-file-input" accept=".csv,.txt" class="mb-2 text-sm" onchange="handleCsvFile(event)">
                <textarea id="csv-import-data" class="input-field w-full h-32 p-3 rounded-lg num text-sm" placeholder="CSV hier einf√ºgen..."></textarea>
            </div>
            <div class="flex items-center gap-3 mb-4">
                <input type="checkbox" id="csv-replace-mode" class="w-4 h-4 accent-teal-600" checked="">
                <label for="csv-replace-mode" class="text-sm" style="color: var(--text-secondary)">Bestehende Einheiten ersetzen</label>
            </div>
            <div id="csv-preview" class="hidden mb-4">
                <p class="text-sm font-medium mb-2">Vorschau (<span id="csv-preview-count">0</span> Einheiten):</p>
                <div class="overflow-x-auto max-h-40 scrollbar-thin rounded-lg" style="background: var(--bg-tertiary)">
                    <table class="w-full text-xs"><thead><tr class="sticky top-0" style="background: var(--bg-tertiary)">
                        <th class="p-2 text-left">ID</th><th class="p-2 text-right">VP</th><th class="p-2 text-left">Typ</th>
                        <th class="p-2 text-right">m¬≤</th><th class="p-2 text-right">Basic</th><th class="p-2 text-right">Premium</th>
                    </tr></thead><tbody id="csv-preview-body"></tbody></table>
                </div>
            </div>
            <div id="csv-errors" class="hidden mb-4 p-3 rounded-lg over-budget">
                <p class="text-sm font-medium mb-1" style="color: var(--danger)">‚ö†Ô∏è Fehler:</p>
                <ul id="csv-error-list" class="text-xs list-disc list-inside" style="color: var(--danger)"></ul>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="hideCsvModal()" class="px-4 py-2 rounded-lg btn-secondary">Abbrechen</button>
                <button onclick="previewCsv()" class="px-4 py-2 rounded-lg btn-secondary">Vorschau</button>
                <button onclick="executeCsvImport()" class="btn-primary px-4 py-2 rounded-lg">Importieren</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden px-4 py-3 rounded-lg shadow-lg animate-fade-in" style="background: var(--accent); color: white">
        <span id="toast-message"></span>
    </div>

    <script>
        // ==================== DATA STORE ====================
        const SURCHARGE_RATE = 0.20;
        let appData = {
            optionPrices: { sonos: null, whirlpool: null, cheminee: null, weissputz: null, blockfutter: null, einbauschrank: null, eladestation: null },
            optionDescriptions: { sonos: '', whirlpool: '', cheminee: '', weissputz: '', blockfutter: '', elektro: '', einbauschrank: '', eladestation: '' },
            premiumBetreuung: 15000,  // Automatische Pauschale f√ºr Premium-Line K√§uferbetreuung
            premiumElektro: 2000,     // Automatischer Zuschlag pro Zimmer f√ºr Elektroinstallationen (Premium)
            kulanzSchwelle: 0,        // Budget-√úberschreitungen unter dieser Schwelle werden nicht verrechnet
            parkplatzPreis: 45000,    // Preis pro Pflicht-Parkplatz (gem. CSV)
            zusatzparkplatzPreis: 45000, // Preis pro Zusatzparkplatz (Option)
            bastelraumPreis: 15000,   // Preis pro Bastelraum (Option)
            kostenprognose: 0,        // Geplante Kosten f√ºr Gewinnberechnung
            units: []  // Each unit has: id, salePrice, category, apartmentType, isAttika, zimmer, bodenM2, plattenM2, verputzM2, tueren, parkplaetze, budgets{basic,premium}, buyer{...}
        };

        // ==================== DARK MODE ====================
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            document.documentElement.classList.toggle('dark', e.matches);
        });

        // ==================== TAB NAVIGATION ====================
        function switchTab(tabId) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.style.color = 'var(--text-secondary)';
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            const tab = document.getElementById(`tab-${tabId}`);
            tab.classList.add('tab-active');
            tab.style.color = 'var(--accent)';

            if (tabId === 'units') renderUnitsTable();
            if (tabId === 'buyers') { populateBuyerUnitSelect(); renderBuyersTable(); updateOptionPriceDisplays(); }
            if (tabId === 'configurator') { populateConfigUnitSelect(); }
            if (tabId === 'buyer-report') populateReportSelect();
            if (tabId === 'project-report') renderProjectReport();
        }

        // ==================== SETTINGS ====================
        function loadSettings() {
            document.getElementById('price-premium-betreuung').value = appData.premiumBetreuung || 15000;
            document.getElementById('price-premium-elektro').value = appData.premiumElektro || 2000;
            document.getElementById('price-kostenprognose').value = appData.kostenprognose || 0;
            document.getElementById('price-kulanz-schwelle').value = appData.kulanzSchwelle || 0;
            document.getElementById('price-parkplatz').value = appData.parkplatzPreis || 45000;
            document.getElementById('price-zusatzparkplatz').value = appData.zusatzparkplatzPreis || 45000;
            document.getElementById('price-bastelraum').value = appData.bastelraumPreis || 15000;
            document.getElementById('price-sonos').value = appData.optionPrices.sonos || '';
            document.getElementById('price-whirlpool').value = appData.optionPrices.whirlpool || '';
            document.getElementById('price-cheminee').value = appData.optionPrices.cheminee || '';
            document.getElementById('price-weissputz').value = appData.optionPrices.weissputz || '';
            document.getElementById('price-blockfutter').value = appData.optionPrices.blockfutter || '';
            document.getElementById('price-einbauschrank').value = appData.optionPrices.einbauschrank || '';
            document.getElementById('price-eladestation').value = appData.optionPrices.eladestation || '';
            // Beschreibungen laden
            document.getElementById('desc-sonos').value = appData.optionDescriptions.sonos || '';
            document.getElementById('desc-whirlpool').value = appData.optionDescriptions.whirlpool || '';
            document.getElementById('desc-cheminee').value = appData.optionDescriptions.cheminee || '';
            document.getElementById('desc-weissputz').value = appData.optionDescriptions.weissputz || '';
            document.getElementById('desc-blockfutter').value = appData.optionDescriptions.blockfutter || '';
            document.getElementById('desc-elektro').value = appData.optionDescriptions.elektro || '';
            document.getElementById('desc-einbauschrank').value = appData.optionDescriptions.einbauschrank || '';
            document.getElementById('desc-eladestation').value = appData.optionDescriptions.eladestation || '';
        }

        function saveSettings() {
            appData.premiumBetreuung = parseInt(document.getElementById('price-premium-betreuung').value) || 0;
            appData.premiumElektro = parseInt(document.getElementById('price-premium-elektro').value) || 0;
            appData.kostenprognose = parseInt(document.getElementById('price-kostenprognose').value) || 0;
            appData.kulanzSchwelle = parseInt(document.getElementById('price-kulanz-schwelle').value) || 0;
            appData.parkplatzPreis = parseInt(document.getElementById('price-parkplatz').value) || 0;
            appData.zusatzparkplatzPreis = parseInt(document.getElementById('price-zusatzparkplatz').value) || 0;
            appData.bastelraumPreis = parseInt(document.getElementById('price-bastelraum').value) || 0;
            appData.optionPrices.sonos = parseInt(document.getElementById('price-sonos').value) || null;
            appData.optionPrices.whirlpool = parseInt(document.getElementById('price-whirlpool').value) || null;
            appData.optionPrices.cheminee = parseInt(document.getElementById('price-cheminee').value) || null;
            appData.optionPrices.weissputz = parseInt(document.getElementById('price-weissputz').value) || null;
            appData.optionPrices.blockfutter = parseInt(document.getElementById('price-blockfutter').value) || null;
            appData.optionPrices.einbauschrank = parseInt(document.getElementById('price-einbauschrank').value) || null;
            appData.optionPrices.eladestation = parseInt(document.getElementById('price-eladestation').value) || null;
            // Beschreibungen speichern
            appData.optionDescriptions.sonos = document.getElementById('desc-sonos').value || '';
            appData.optionDescriptions.whirlpool = document.getElementById('desc-whirlpool').value || '';
            appData.optionDescriptions.cheminee = document.getElementById('desc-cheminee').value || '';
            appData.optionDescriptions.weissputz = document.getElementById('desc-weissputz').value || '';
            appData.optionDescriptions.blockfutter = document.getElementById('desc-blockfutter').value || '';
            appData.optionDescriptions.elektro = document.getElementById('desc-elektro').value || '';
            appData.optionDescriptions.einbauschrank = document.getElementById('desc-einbauschrank').value || '';
            appData.optionDescriptions.eladestation = document.getElementById('desc-eladestation').value || '';
            showToast('Einstellungen gespeichert ‚úì');
        }

        function updateOptionPriceDisplays(unit = null) {
            const zimmer = unit ? (unit.zimmer || 0) : 0;
            const pflichtPP = unit ? (unit.parkplaetze || 0) : 0;

            // Pflicht-Parkpl√§tze anzeigen
            const pflichtPPEl = document.getElementById('buyer-pflicht-pp');
            const pflichtPPPreisEl = document.getElementById('buyer-pflicht-pp-preis');
            if (pflichtPPEl) {
                pflichtPPEl.textContent = pflichtPP;
                if (pflichtPP > 0 && appData.parkplatzPreis) {
                    pflichtPPPreisEl.textContent = `${pflichtPP} √ó ${formatCHF(appData.parkplatzPreis)} = +${formatCHF(pflichtPP * appData.parkplatzPreis)}`;
                } else {
                    pflichtPPPreisEl.textContent = '';
                }
            }

            // Zusatzparkplatz Preis
            const zusatzPPEl = document.getElementById('opt-price-zusatzpp');
            if (zusatzPPEl) zusatzPPEl.textContent = appData.zusatzparkplatzPreis ? `${formatCHF(appData.zusatzparkplatzPreis)}/Stk` : '‚Äì';

            // Bastelraum Preis
            const bastelraumEl = document.getElementById('opt-price-bastelraum');
            if (bastelraumEl) bastelraumEl.textContent = appData.bastelraumPreis ? `${formatCHF(appData.bastelraumPreis)}/Stk` : '‚Äì';

            // Sonos pro Zimmer
            const sonosEl = document.getElementById('opt-price-sonos');
            if (sonosEl) {
                if (appData.optionPrices.sonos && zimmer > 0) {
                    sonosEl.textContent = `${formatCHF(Math.round(appData.optionPrices.sonos * zimmer))} (${zimmer} Zi)`;
                } else if (appData.optionPrices.sonos) {
                    sonosEl.textContent = `${formatCHF(appData.optionPrices.sonos)}/Zi`;
                } else {
                    sonosEl.textContent = '‚Äì';
                }
            }
            // Whirlpool und Cheminee fix
            ['whirlpool', 'cheminee'].forEach(opt => {
                const el = document.getElementById(`opt-price-${opt}`);
                if (el) el.textContent = appData.optionPrices[opt] ? formatCHF(appData.optionPrices[opt]) : '‚Äì';
            });

            // Elektro, Weissputz und Blockfutter (nur bei Basic relevant, mit 30% Aufschlag)
            const BASIC_OPTION_SURCHARGE = 1.30;  // 30% Aufschlag bei Basic
            const verputzM2 = unit ? (unit.verputzM2 || 0) : 0;
            const tueren = unit ? (unit.tueren || 0) : 0;

            // Elektro-Option (mit 30% Aufschlag bei Basic)
            const elektroRow = document.getElementById('opt-row-elektro');
            const elektroEl = document.getElementById('opt-price-elektro');
            const zimmerLabel = document.getElementById('buyer-zimmer-anzahl');
            if (elektroRow && appData.premiumElektro && zimmer > 0) {
                const elektroPreis = Math.round(appData.premiumElektro * zimmer * BASIC_OPTION_SURCHARGE);
                elektroEl.textContent = formatCHF(elektroPreis);
                zimmerLabel.textContent = `(${zimmer} Zi)`;
            } else if (elektroEl) {
                elektroEl.textContent = '‚Äì';
            }

            // Weissputz-Option (mit 30% Aufschlag bei Basic)
            const weissputzEl = document.getElementById('opt-price-weissputz');
            const verputzLabel = document.getElementById('buyer-verputz-m2');
            if (verputzM2 > 0 && appData.optionPrices.weissputz) {
                const weissputzPreis = Math.round(verputzM2 * appData.optionPrices.weissputz * BASIC_OPTION_SURCHARGE);
                weissputzEl.textContent = formatCHF(weissputzPreis);
                verputzLabel.textContent = `(${verputzM2} m¬≤)`;
            } else if (weissputzEl) {
                weissputzEl.textContent = '‚Äì';
                verputzLabel.textContent = '';
            }

            // Blockfutter-Option (mit 30% Aufschlag bei Basic)
            const blockfutterEl = document.getElementById('opt-price-blockfutter');
            const tuerenLabel = document.getElementById('buyer-tueren-anzahl');
            if (tueren > 0 && appData.optionPrices.blockfutter) {
                const blockfutterPreis = Math.round(tueren * appData.optionPrices.blockfutter * BASIC_OPTION_SURCHARGE);
                blockfutterEl.textContent = formatCHF(blockfutterPreis);
                tuerenLabel.textContent = `(${tueren} T&uuml;ren)`;
            } else if (blockfutterEl) {
                blockfutterEl.textContent = '‚Äì';
                tuerenLabel.textContent = '';
            }

            // Einbauschrank-Option (mit 20% Aufschlag) - Preis pro m' anzeigen
            const EINBAUSCHRANK_SURCHARGE = 1.20;  // 20% Aufschlag f√ºr Einbauschr√§nke
            const einbauschankEl = document.getElementById('opt-price-einbauschrank');
            const einbauschankInput = document.getElementById('buyer-opt-einbauschrank-lfm');
            if (einbauschankEl && appData.optionPrices.einbauschrank) {
                const lfm = parseFloat(einbauschankInput?.value) || 0;
                if (lfm > 0) {
                    const einbauschankPreis = Math.round(lfm * appData.optionPrices.einbauschrank * EINBAUSCHRANK_SURCHARGE);
                    einbauschankEl.textContent = formatCHF(einbauschankPreis);
                } else {
                    einbauschankEl.textContent = `${formatCHF(Math.round(appData.optionPrices.einbauschrank * EINBAUSCHRANK_SURCHARGE))}/m'`;
                }
            } else if (einbauschankEl) {
                einbauschankEl.textContent = '‚Äì';
            }

            // Event-Listener f√ºr Einbauschrank-Eingabe
            if (einbauschankInput && !einbauschankInput.dataset.listenerAttached) {
                einbauschankInput.addEventListener('input', () => updateOptionPriceDisplays(unit));
                einbauschankInput.dataset.listenerAttached = 'true';
            }

            // E-Ladestation Option - Preis pro St√ºck anzeigen
            const eladestationEl = document.getElementById('opt-price-eladestation');
            const eladestationInput = document.getElementById('buyer-opt-eladestation');
            if (eladestationEl && appData.optionPrices.eladestation) {
                const anzahl = parseInt(eladestationInput?.value) || 0;
                if (anzahl > 0) {
                    const eladestationPreis = anzahl * appData.optionPrices.eladestation;
                    eladestationEl.textContent = formatCHF(eladestationPreis);
                } else {
                    eladestationEl.textContent = `${formatCHF(appData.optionPrices.eladestation)}/Stk.`;
                }
            } else if (eladestationEl) {
                eladestationEl.textContent = '‚Äì';
            }

            // Event-Listener f√ºr E-Ladestation-Eingabe
            if (eladestationInput && !eladestationInput.dataset.listenerAttached) {
                eladestationInput.addEventListener('input', () => updateOptionPriceDisplays(unit));
                eladestationInput.dataset.listenerAttached = 'true';
            }

            // Basic-Optionen Container - immer anzeigen
            const basicOptContainer = document.getElementById('buyer-basic-options-container');
            if (basicOptContainer) {
                basicOptContainer.style.display = 'block';
            }
        }

        // ==================== UNITS TABLE ====================
        function renderUnitsTable() {
            const tbody = document.getElementById('units-table-body');
            document.getElementById('units-count').textContent = `${appData.units.length} Einheiten`;

            if (appData.units.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center" style="color: var(--text-muted)">Noch keine Einheiten ‚Äì bitte per CSV importieren</td></tr>';
                return;
            }

            tbody.innerHTML = appData.units.map(u => {
                let typeLabel = u.category.toUpperCase();
                if (u.category === 'wohnung') typeLabel = `${u.apartmentType || '?'}${u.isAttika ? ' (A)' : ''}`;

                const basicTotal = u.budgets.basic.boden + u.budgets.basic.kueche + u.budgets.basic.sanitaer;
                const premiumTotal = u.budgets.premium.boden + u.budgets.premium.kueche + u.budgets.premium.sanitaer;

                return `<tr style="border-bottom: 1px solid var(--border-color)">
                    <td class="p-3 font-medium">${esc(u.id)}</td>
                    <td class="p-3">${esc(typeLabel)}</td>
                    <td class="p-3 text-right num">${formatCHF(u.salePrice)}</td>
                    <td class="p-3 text-center num">${u.parkplaetze || 0}</td>
                    <td class="p-3 text-right num" style="color: #1e40af">${formatCHF(basicTotal)}</td>
                    <td class="p-3 text-right num" style="color: var(--premium)">${formatCHF(premiumTotal)}</td>
                    <td class="p-3 text-center">
                        <button onclick="deleteUnit('${esc(u.id)}')" class="text-red-500 hover:text-red-700" title="L√∂schen">‚úï</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function deleteUnit(id) {
            showConfirmDialog(`Einheit "${id}" l√∂schen?`, () => {
                appData.units = appData.units.filter(u => u.id !== id);
                renderUnitsTable();
                showToast('Einheit gel√∂scht');
            });
        }

        // ==================== CSV IMPORT ====================
        let parsedUnits = [];

        function showCsvImportModal() {
            document.getElementById('csv-import-modal').classList.remove('hidden');
            document.getElementById('csv-import-modal').classList.add('flex');
            document.getElementById('csv-import-data').value = '';
            document.getElementById('csv-file-input').value = '';
            document.getElementById('csv-preview').classList.add('hidden');
            document.getElementById('csv-errors').classList.add('hidden');
            parsedUnits = [];
        }

        function hideCsvModal() {
            document.getElementById('csv-import-modal').classList.add('hidden');
            document.getElementById('csv-import-modal').classList.remove('flex');
        }

        function handleCsvFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('csv-import-data').value = ev.target.result;
                previewCsv();
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCsvLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let c of line) {
                if (c === '"') inQuotes = !inQuotes;
                else if (c === ';' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += c;
            }
            result.push(current.trim());
            return result;
        }

        function parseBool(val) {
            if (!val) return false;
            const v = val.toLowerCase().trim();
            return ['ja','yes','1','true','x'].includes(v);
        }

        function previewCsv() {
            const csv = document.getElementById('csv-import-data').value.trim();
            const errorsEl = document.getElementById('csv-errors');
            const errorListEl = document.getElementById('csv-error-list');
            const previewEl = document.getElementById('csv-preview');
            const previewBody = document.getElementById('csv-preview-body');

            errorsEl.classList.add('hidden');
            previewEl.classList.add('hidden');
            parsedUnits = [];

            if (!csv) { showToast('Bitte CSV eingeben', 'error'); return; }

            const lines = csv.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) { showToast('CSV muss Header + Daten enthalten', 'error'); return; }

            const errors = [];
            const units = [];

            for (let i = 1; i < lines.length; i++) {
                const ln = i + 1;
                const cols = parseCsvLine(lines[i]);
                if (cols.length < 16) { errors.push(`Zeile ${ln}: ${cols.length}/16 Spalten`); continue; }

                const [idPrefix, vp, kat, typ, attika, zimmer, boden_m2, platten_m2, verputz_m2, tueren_col, basic_m2, basic_k, basic_s, prem_m2, prem_k, prem_s, stueck, pp] = cols;

                if (!idPrefix) { errors.push(`Zeile ${ln}: ID fehlt`); continue; }
                if (!vp || isNaN(parseInt(vp))) { errors.push(`Zeile ${ln}: Ung√ºltiger VP`); continue; }
                if (!['wohnung','defh','efh'].includes(kat.toLowerCase())) { errors.push(`Zeile ${ln}: Ung√ºltige Kategorie`); continue; }

                const cat = kat.toLowerCase();
                const isAttika = parseBool(attika);
                const zimmerAnzahl = parseFloat(zimmer) || 0;
                const bodenM2 = parseFloat(boden_m2) || 0;
                const plattenM2 = parseFloat(platten_m2) || 0;
                const verputzM2 = parseFloat(verputz_m2) || 0;
                const tueren = parseInt(tueren_col) || 0;
                const bodenWandM2 = bodenM2 + plattenM2;  // F√ºr Boden/Wand-Budgets (ohne Verputz)
                const stueckzahl = parseInt(stueck) || 1;
                const parkplaetze = parseInt(pp) || 0;

                // Generiere Einheiten basierend auf St√ºckzahl
                for (let n = 1; n <= stueckzahl; n++) {
                    const unitId = stueckzahl > 1 ? `${idPrefix.trim()}-${String(n).padStart(2, '0')}` : idPrefix.trim();

                    const unit = {
                        id: unitId,
                        salePrice: parseInt(vp) || 0,
                        category: cat,
                        apartmentType: cat === 'wohnung' ? (typ.trim() || null) : null,
                        isAttika,
                        zimmer: zimmerAnzahl,
                        bodenM2,
                        plattenM2,
                        verputzM2,
                        tueren,
                        parkplaetze,
                        budgets: {
                            basic: {
                                boden: Math.round(bodenWandM2 * (parseFloat(basic_m2) || 0)),
                                kueche: parseInt(basic_k) || 0,
                                sanitaer: parseInt(basic_s) || 0
                            },
                            premium: {
                                boden: Math.round(bodenWandM2 * (parseFloat(prem_m2) || 0)),
                                kueche: parseInt(prem_k) || 0,
                                sanitaer: parseInt(prem_s) || 0
                            }
                        },
                        buyer: null
                    };

                    if (units.some(u => u.id === unit.id)) { errors.push(`Zeile ${ln}: Doppelte ID "${unit.id}"`); continue; }
                    units.push(unit);
                }
            }

            parsedUnits = units;

            if (errors.length > 0) {
                errorsEl.classList.remove('hidden');
                errorListEl.innerHTML = errors.map(e => `<li>${esc(e)}</li>`).join('');
            }

            if (units.length > 0) {
                previewEl.classList.remove('hidden');
                document.getElementById('csv-preview-count').textContent = units.length;
                previewBody.innerHTML = units.slice(0, 20).map(u => {
                    let typeLabel = u.category.toUpperCase();
                    if (u.category === 'wohnung') typeLabel = `${u.apartmentType || '?'}${u.isAttika ? ' (A)' : ''}`;
                    const basicT = u.budgets.basic.boden + u.budgets.basic.kueche + u.budgets.basic.sanitaer;
                    const premT = u.budgets.premium.boden + u.budgets.premium.kueche + u.budgets.premium.sanitaer;
                    return `<tr style="border-bottom: 1px solid var(--border-color)">
                        <td class="p-2">${esc(u.id)}</td>
                        <td class="p-2 text-right num">${formatCHF(u.salePrice)}</td>
                        <td class="p-2">${esc(typeLabel)}</td>
                        <td class="p-2 text-right">${u.bodenM2}</td>
                        <td class="p-2 text-right num">${formatCHF(basicT)}</td>
                        <td class="p-2 text-right num">${formatCHF(premT)}</td>
                    </tr>`;
                }).join('');
                showToast(`${units.length} Einheiten erkannt ‚úì`);
            } else {
                showToast('Keine g√ºltigen Einheiten', 'error');
            }
        }

        function executeCsvImport() {
            if (parsedUnits.length === 0) { showToast('Bitte zuerst Vorschau', 'error'); return; }

            if (document.getElementById('csv-replace-mode').checked) {
                appData.units = parsedUnits;
            } else {
                const existingIds = appData.units.map(u => u.id);
                const dupes = parsedUnits.filter(u => existingIds.includes(u.id));
                if (dupes.length > 0) { showToast(`${dupes.length} IDs existieren bereits`, 'error'); return; }
                appData.units.push(...parsedUnits);
            }

            renderUnitsTable();
            hideCsvModal();
            showToast(`${parsedUnits.length} Einheiten importiert ‚úì`);
        }

        // ==================== SETTINGS CSV IMPORT ====================
        function showSettingsCsvImportModal() {
            const modal = document.createElement('div');
            modal.id = 'settings-csv-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.style.background = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-xl" style="background: var(--bg-primary); border: 1px solid var(--border-color)">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üìÑ Einstellungen CSV Import</h2>
                        <button onclick="hideSettingsCsvModal()" class="text-2xl" style="color: var(--text-muted)">&times;</button>
                    </div>
                    <p class="text-sm mb-4" style="color: var(--text-muted)">
                        Format: Spalten√ºberschriften in Zeile 1, Werte in Zeile 2 (Semikolon-getrennt)
                    </p>
                    <div class="mb-4 p-3 rounded-lg text-xs" style="background: var(--bg-secondary)">
                        <p class="font-semibold mb-2">Unterst√ºtzte Spalten:</p>
                        <div class="grid grid-cols-3 md:grid-cols-4 gap-1" style="color: var(--text-secondary)">
                            <span>premium_betreuung</span>
                            <span>premium_elektro</span>
                            <span>kostenprognose</span>
                            <span>kulanz_schwelle</span>
                            <span>parkplatz</span>
                            <span>zusatzparkplatz</span>
                            <span>bastelraum</span>
                            <span>knx</span>
                            <span>sonos</span>
                            <span>whirlpool</span>
                            <span>cheminee</span>
                            <span>weissputz</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">CSV-Datei w√§hlen</label>
                        <input type="file" id="settings-csv-file" accept=".csv,.txt" onchange="handleSettingsCsvFile(event)" class="w-full">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Oder direkt einf√ºgen:</label>
                        <textarea id="settings-csv-data" rows="4" class="input-field w-full p-3 rounded-lg font-mono text-sm" placeholder="premium_betreuung;premium_elektro;knx;sonos;whirlpool;cheminee;parkplatz
15000;2000;4000;1000;25000;12000;45000"></textarea>
                    </div>
                    <div id="settings-csv-preview" class="hidden mb-4 p-4 rounded-lg" style="background: var(--bg-secondary)">
                        <p class="font-semibold mb-2">Vorschau:</p>
                        <div id="settings-csv-preview-content" class="text-sm"></div>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button onclick="hideSettingsCsvModal()" class="px-4 py-2 rounded-lg" style="color: var(--text-secondary)">Abbrechen</button>
                        <button onclick="previewSettingsCsv()" class="px-4 py-2 rounded-lg border" style="border-color: var(--border-color)">üëÅ Vorschau</button>
                        <button onclick="executeSettingsCsvImport()" class="btn-primary px-4 py-2 rounded-lg">‚úì Importieren</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function hideSettingsCsvModal() {
            const modal = document.getElementById('settings-csv-modal');
            if (modal) modal.remove();
        }

        function handleSettingsCsvFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                document.getElementById('settings-csv-data').value = ev.target.result;
                previewSettingsCsv();
            };
            reader.readAsText(file, 'UTF-8');
        }

        let parsedSettings = {};

        function previewSettingsCsv() {
            const csv = document.getElementById('settings-csv-data').value.trim();
            const previewEl = document.getElementById('settings-csv-preview');
            const contentEl = document.getElementById('settings-csv-preview-content');

            parsedSettings = {};

            if (!csv) {
                showToast('Bitte CSV eingeben', 'error');
                previewEl.classList.add('hidden');
                return;
            }

            const keyMap = {
                'premium_betreuung': { field: 'premiumBetreuung', label: 'Premium Betreuung' },
                'premium_elektro': { field: 'premiumElektro', label: 'Premium Elektro' },
                'kostenprognose': { field: 'kostenprognose', label: 'Kostenprognose' },
                'kulanz_schwelle': { field: 'kulanzSchwelle', label: 'Kulanz-Schwelle' },
                'parkplatz': { field: 'parkplatzPreis', label: 'Parkplatz' },
                'zusatzparkplatz': { field: 'zusatzparkplatzPreis', label: 'Zusatzparkplatz' },
                'bastelraum': { field: 'bastelraumPreis', label: 'Bastelraum' },
                'sonos': { field: 'optionPrices.sonos', label: 'W-Lan Soundsystem' },
                'whirlpool': { field: 'optionPrices.whirlpool', label: 'Whirlpool' },
                'cheminee': { field: 'optionPrices.cheminee', label: 'Chemin√©e' },
                'weissputz': { field: 'optionPrices.weissputz', label: 'Weissputz' },
                'blockfutter': { field: 'optionPrices.blockfutter', label: 'Blockfutter' }
            };

            const lines = csv.split(/\r?\n/).filter(l => l.trim());

            if (lines.length < 2) {
                showToast('CSV muss Header + Werte-Zeile enthalten', 'error');
                previewEl.classList.add('hidden');
                return;
            }

            // Spaltenformat: Zeile 1 = Header, Zeile 2 = Werte
            const headers = parseCsvLine(lines[0]);
            const values = parseCsvLine(lines[1]);

            const recognized = [];
            const unknown = [];

            headers.forEach((header, idx) => {
                const key = header.toLowerCase().trim();
                const value = parseFloat((values[idx] || '').replace(/[^\d.-]/g, '')) || 0;

                if (keyMap[key]) {
                    parsedSettings[keyMap[key].field] = value;
                    recognized.push({ label: keyMap[key].label, value: value });
                } else if (key) {
                    unknown.push(key);
                }
            });

            if (recognized.length === 0) {
                showToast('Keine g√ºltigen Einstellungen gefunden', 'error');
                previewEl.classList.add('hidden');
                return;
            }

            previewEl.classList.remove('hidden');
            contentEl.innerHTML = `
                <div class="space-y-1">
                    ${recognized.map(r => `<div class="flex justify-between"><span>${esc(r.label)}</span><span class="num font-semibold">${formatCHF(r.value)}</span></div>`).join('')}
                </div>
                ${unknown.length > 0 ? `<p class="mt-3 text-xs" style="color: var(--error)">Unbekannte Spalten: ${unknown.join(', ')}</p>` : ''}
            `;
        }

        function executeSettingsCsvImport() {
            if (Object.keys(parsedSettings).length === 0) {
                showToast('Bitte zuerst Vorschau anzeigen', 'error');
                return;
            }

            // Apply parsed settings
            Object.entries(parsedSettings).forEach(([field, value]) => {
                if (field.startsWith('optionPrices.')) {
                    const optKey = field.split('.')[1];
                    appData.optionPrices[optKey] = value;
                } else {
                    appData[field] = value;
                }
            });

            // Update form fields
            loadSettings();
            hideSettingsCsvModal();
            showToast(`${Object.keys(parsedSettings).length} Einstellungen importiert ‚úì`);
        }

        // ==================== BUYERS ====================
        function populateBuyerUnitSelect() {
            const select = document.getElementById('buyer-unit-select');
            const unitsWithoutBuyer = appData.units.filter(u => !u.buyer);
            select.innerHTML = '<option value="">‚Äì Einheit w√§hlen ‚Äì</option>' +
                unitsWithoutBuyer.map(u => `<option value="${esc(u.id)}">${esc(u.id)} ‚Äì ${esc(getTypeLabel(u))}</option>`).join('');
        }

        function getTypeLabel(u) {
            if (u.category === 'wohnung') return `${u.apartmentType || '?'}${u.isAttika ? ' (Attika)' : ''}`;
            return u.category.toUpperCase();
        }

        function onBuyerUnitChange() {
            const unitId = document.getElementById('buyer-unit-select').value;
            const infoEl = document.getElementById('buyer-unit-info');
            const lineSelect = document.getElementById('buyer-line');
            const whirlpoolCheck = document.getElementById('buyer-opt-whirlpool');
            const chemineeCheck = document.getElementById('buyer-opt-cheminee');
            const attikaLabel = document.getElementById('attika-options-label');
            const whirlpoolRow = document.getElementById('opt-row-whirlpool');
            const chemineeRow = document.getElementById('opt-row-cheminee');

            const elektroCheck = document.getElementById('buyer-opt-elektro');
            const weissputzCheck = document.getElementById('buyer-opt-weissputz');
            const blockfutterCheck = document.getElementById('buyer-opt-blockfutter');

            if (!unitId) {
                infoEl.classList.add('hidden');
                // Attika-Optionen deaktivieren
                whirlpoolCheck.disabled = true;
                chemineeCheck.disabled = true;
                whirlpoolCheck.checked = false;
                chemineeCheck.checked = false;
                // Elektro/Weissputz/Blockfutter deaktivieren
                elektroCheck.disabled = true;
                elektroCheck.checked = false;
                weissputzCheck.disabled = true;
                blockfutterCheck.disabled = true;
                weissputzCheck.checked = false;
                blockfutterCheck.checked = false;
                return;
            }

            const unit = appData.units.find(u => u.id === unitId);
            if (!unit) return;

            infoEl.classList.remove('hidden');
            infoEl.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div><span style="color: var(--text-muted)">Typ:</span> ${esc(getTypeLabel(unit))}</div>
                    <div><span style="color: var(--text-muted)">VP:</span> ${formatCHF(unit.salePrice)}</div>
                    <div><span style="color: var(--text-muted)">Zimmer:</span> ${unit.zimmer || '‚Äì'}</div>
                    <div><span style="color: var(--text-muted)">Fl√§che:</span> ${unit.bodenM2} m¬≤</div>
                </div>
            `;

            // Update option prices with room count
            updateOptionPriceDisplays(unit);

            // Attika-Optionen: immer sichtbar, aber nur f√ºr Attika w√§hlbar
            if (unit.isAttika) {
                // Attika: Optionen aktivieren, Premium erzwingen
                whirlpoolCheck.disabled = false;
                chemineeCheck.disabled = false;
                attikaLabel.innerHTML = '‚ú® Attika-Exklusiv ‚Äì <strong>f√ºr Sie verf√ºgbar!</strong>';
                attikaLabel.style.color = 'var(--accent)';
                whirlpoolRow.style.background = 'var(--accent-light)';
                chemineeRow.style.background = 'var(--accent-light)';
                whirlpoolRow.style.opacity = '1';
                chemineeRow.style.opacity = '1';
                lineSelect.value = 'premium';
                lineSelect.disabled = true;
            } else {
                // Nicht-Attika: Optionen deaktiviert, aber sichtbar (macht es "appetitlich")
                whirlpoolCheck.disabled = true;
                chemineeCheck.disabled = true;
                whirlpoolCheck.checked = false;
                chemineeCheck.checked = false;
                attikaLabel.innerHTML = '‚ú® Exklusiv f√ºr Attika-Wohnungen';
                attikaLabel.style.color = 'var(--premium)';
                whirlpoolRow.style.background = 'var(--premium-light)';
                chemineeRow.style.background = 'var(--premium-light)';
                whirlpoolRow.style.opacity = '0.6';
                chemineeRow.style.opacity = '0.6';
                lineSelect.disabled = false;
            }

            // Elektro/Weissputz/Blockfutter: Bei Attika (= Premium) deaktivieren, sonst je nach Linie
            if (unit.isAttika) {
                // Bei Attika ist Premium erzwungen -> Elektro/Weissputz/Blockfutter inklusive
                elektroCheck.disabled = true;
                elektroCheck.checked = false;
                weissputzCheck.disabled = true;
                blockfutterCheck.disabled = true;
                weissputzCheck.checked = false;
                blockfutterCheck.checked = false;
            } else {
                // Aktivierung h√§ngt von der gew√§hlten Linie ab
                const line = lineSelect.value;
                elektroCheck.disabled = (line === 'premium');
                weissputzCheck.disabled = (line === 'premium');
                blockfutterCheck.disabled = (line === 'premium');
                if (line === 'premium') {
                    elektroCheck.checked = false;
                    weissputzCheck.checked = false;
                    blockfutterCheck.checked = false;
                }
            }

            updateBudgetHints(unit);
        }

        function updateBudgetHints(unit) {
            const line = document.getElementById('buyer-line').value;
            const b = unit.budgets[line];
            document.getElementById('budget-hint-boden').textContent = `(Budget: ${formatCHF(b.boden)})`;
            document.getElementById('budget-hint-kueche').textContent = `(Budget: ${formatCHF(b.kueche)})`;
            document.getElementById('budget-hint-sanitaer').textContent = `(Budget: ${formatCHF(b.sanitaer)})`;

            // Premium upgrade info (inkl. Betreuungspauschale + Elektro + Weissputz + Blockfutter)
            const basicT = unit.budgets.basic.boden + unit.budgets.basic.kueche + unit.budgets.basic.sanitaer;
            const premT = unit.budgets.premium.boden + unit.budgets.premium.kueche + unit.budgets.premium.sanitaer;
            const budgetDiff = Math.max(0, premT - basicT);
            const betreuung = appData.premiumBetreuung || 0;
            const elektro = Math.round((appData.premiumElektro || 0) * (unit.zimmer || 0));
            const weissputz = (unit.verputzM2 || 0) * (appData.optionPrices.weissputz || 0);
            const blockfutter = (unit.tueren || 0) * (appData.optionPrices.blockfutter || 0);
            const delta = budgetDiff + betreuung + elektro + weissputz + blockfutter;

            const lineInfoEl = document.getElementById('buyer-line-info');
            const premiumBox = document.getElementById('premium-benefits-box');
            const premiumPriceEl = document.getElementById('premium-upgrade-price');

            if (line === 'premium') {
                // Premium ausgew√§hlt: Benefits-Box anzeigen
                premiumBox.classList.remove('hidden');
                premiumPriceEl.innerHTML = `Inkl. Premium-Leistungen: +${formatCHF(delta)}`;
                lineInfoEl.innerHTML = '';
            } else {
                // Basic ausgew√§hlt: Hinweis auf Premium-Upgrade
                premiumBox.classList.add('hidden');
                if (delta > 0) {
                    lineInfoEl.innerHTML = `<span style="color: var(--premium)">üí° Upgrade auf Premium f√ºr nur +${formatCHF(delta)} m√∂glich</span>`;
                } else {
                    lineInfoEl.innerHTML = '';
                }
            }
        }

        function onBuyerLineChange() {
            const unitId = document.getElementById('buyer-unit-select').value;
            const unit = appData.units.find(u => u.id === unitId);
            if (!unit) return;

            updateBudgetHints(unit);

            // Bei Basic: Elektro/Weissputz/Blockfutter Checkboxen aktivieren
            // Bei Premium: deaktivieren (sind inklusive)
            const line = document.getElementById('buyer-line').value;
            const elektroCheck = document.getElementById('buyer-opt-elektro');
            const weissputzCheck = document.getElementById('buyer-opt-weissputz');
            const blockfutterCheck = document.getElementById('buyer-opt-blockfutter');

            if (line === 'basic') {
                elektroCheck.disabled = false;
                weissputzCheck.disabled = false;
                blockfutterCheck.disabled = false;
            } else {
                elektroCheck.disabled = true;
                elektroCheck.checked = false;
                weissputzCheck.disabled = true;
                blockfutterCheck.disabled = true;
                weissputzCheck.checked = false;
                blockfutterCheck.checked = false;
            }
        }

        document.getElementById('buyer-line').addEventListener('change', onBuyerLineChange);

        document.getElementById('buyer-form').addEventListener('submit', e => {
            e.preventDefault();

            const unitId = document.getElementById('buyer-unit-select').value;
            const buyerName = document.getElementById('buyer-name').value.trim();

            if (!unitId || !buyerName) { showToast('Bitte alle Pflichtfelder ausf√ºllen', 'error'); return; }

            const unit = appData.units.find(u => u.id === unitId);
            if (!unit) return;

            unit.buyer = {
                name: buyerName,
                line: unit.isAttika ? 'premium' : document.getElementById('buyer-line').value,
                costs: {
                    boden: parseInt(document.getElementById('buyer-cost-boden').value) || 0,
                    kueche: parseInt(document.getElementById('buyer-cost-kueche').value) || 0,
                    sanitaer: parseInt(document.getElementById('buyer-cost-sanitaer').value) || 0
                },
                zusatzparkplaetze: parseInt(document.getElementById('buyer-opt-zusatzpp').value) || 0,
                bastelraeume: parseInt(document.getElementById('buyer-opt-bastelraum').value) || 0,
                options: {
                    sonos: document.getElementById('buyer-opt-sonos').checked,
                    // Elektro/Weissputz/Blockfutter nur bei Basic speichern (bei Premium automatisch inklusive)
                    elektro: (!unit.isAttika && document.getElementById('buyer-line').value === 'basic') ? document.getElementById('buyer-opt-elektro').checked : false,
                    weissputz: (!unit.isAttika && document.getElementById('buyer-line').value === 'basic') ? document.getElementById('buyer-opt-weissputz').checked : false,
                    blockfutter: (!unit.isAttika && document.getElementById('buyer-line').value === 'basic') ? document.getElementById('buyer-opt-blockfutter').checked : false,
                    einbauschrank: parseFloat(document.getElementById('buyer-opt-einbauschrank-lfm').value) || 0,
                    eladestation: parseInt(document.getElementById('buyer-opt-eladestation').value) || 0,
                    whirlpool: unit.isAttika ? document.getElementById('buyer-opt-whirlpool').checked : false,
                    cheminee: unit.isAttika ? document.getElementById('buyer-opt-cheminee').checked : false
                }
            };

            document.getElementById('buyer-form').reset();
            document.getElementById('buyer-unit-info').classList.add('hidden');
            document.getElementById('premium-benefits-box').classList.add('hidden');
            document.getElementById('buyer-line-info').innerHTML = '';
            document.getElementById('buyer-line').disabled = false;
            document.getElementById('buyer-opt-zusatzpp').value = 0;
            document.getElementById('buyer-opt-bastelraum').value = 0;
            document.getElementById('buyer-opt-einbauschrank-lfm').value = 0;
            document.getElementById('buyer-opt-eladestation').value = 0;
            document.getElementById('buyer-pflicht-pp').textContent = '0';
            document.getElementById('buyer-pflicht-pp-preis').textContent = '';
            document.getElementById('buyer-opt-whirlpool').disabled = true;
            document.getElementById('buyer-opt-cheminee').disabled = true;
            document.getElementById('buyer-opt-whirlpool').checked = false;
            document.getElementById('buyer-opt-cheminee').checked = false;
            ['boden','kueche','sanitaer'].forEach(g => document.getElementById(`budget-hint-${g}`).textContent = '');

            populateBuyerUnitSelect();
            renderBuyersTable();
            showToast('K√§ufer gespeichert ‚úì');
        });

        function renderBuyersTable() {
            const tbody = document.getElementById('buyers-table-body');
            const unitsWithBuyer = appData.units.filter(u => u.buyer);

            if (unitsWithBuyer.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center" style="color: var(--text-muted)">Noch keine K√§ufer erfasst</td></tr>';
                return;
            }

            tbody.innerHTML = unitsWithBuyer.map(u => {
                const calc = calculateTotals(u);
                return `<tr style="border-bottom: 1px solid var(--border-color)">
                    <td class="p-3 font-medium">${esc(u.id)}</td>
                    <td class="p-3">${esc(u.buyer.name)}</td>
                    <td class="p-3 text-center">
                        <span class="badge" style="background: ${u.buyer.line === 'premium' ? '#f3e8ff' : '#dbeafe'}; color: ${u.buyer.line === 'premium' ? '#7c3aed' : '#1e40af'}">
                            ${u.buyer.line === 'premium' ? 'Premium' : 'Basic'}
                        </span>
                    </td>
                    <td class="p-3 text-right num ${calc.totalAufpreise > 0 ? 'over-budget' : ''}" style="border-radius:4px">
                        ${calc.totalAufpreise > 0 ? '+' + formatCHF(calc.totalAufpreise) : '‚Äì'}
                    </td>
                    <td class="p-3 text-right num font-medium" style="color: var(--accent)">${formatCHF(calc.gesamtpreis)}</td>
                    <td class="p-3 text-center">
                        <button onclick="editBuyer('${esc(u.id)}')" class="text-blue-500 hover:text-blue-700 mr-2" title="Bearbeiten">‚úé</button>
                        <button onclick="deleteBuyer('${esc(u.id)}')" class="text-red-500 hover:text-red-700" title="L√∂schen">‚úï</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function deleteBuyer(unitId) {
            showConfirmDialog(`K√§ufer von ${unitId} l√∂schen?`, () => {
                const unit = appData.units.find(u => u.id === unitId);
                if (unit) unit.buyer = null;
                populateBuyerUnitSelect();
                renderBuyersTable();
                showToast('K√§ufer gel√∂scht');
            });
        }

        function editBuyer(unitId) {
            const unit = appData.units.find(u => u.id === unitId);
            if (!unit || !unit.buyer) return;

            // Pre-fill form
            populateBuyerUnitSelect();
            // Add this unit back to select temporarily
            const select = document.getElementById('buyer-unit-select');
            select.innerHTML += `<option value="${esc(unit.id)}" selected>${esc(unit.id)} ‚Äì ${esc(getTypeLabel(unit))}</option>`;

            document.getElementById('buyer-name').value = unit.buyer.name;
            document.getElementById('buyer-line').value = unit.buyer.line;
            document.getElementById('buyer-cost-boden').value = unit.buyer.costs.boden || '';
            document.getElementById('buyer-cost-kueche').value = unit.buyer.costs.kueche || '';
            document.getElementById('buyer-cost-sanitaer').value = unit.buyer.costs.sanitaer || '';
            document.getElementById('buyer-opt-sonos').checked = unit.buyer.options.sonos;
            document.getElementById('buyer-opt-elektro').checked = unit.buyer.options.elektro || false;
            document.getElementById('buyer-opt-weissputz').checked = unit.buyer.options.weissputz || false;
            document.getElementById('buyer-opt-blockfutter').checked = unit.buyer.options.blockfutter || false;
            document.getElementById('buyer-opt-einbauschrank-lfm').value = unit.buyer.options.einbauschrank || 0;
            document.getElementById('buyer-opt-eladestation').value = unit.buyer.options.eladestation || 0;
            if (unit.isAttika) {
                document.getElementById('buyer-opt-whirlpool').checked = unit.buyer.options.whirlpool;
                document.getElementById('buyer-opt-cheminee').checked = unit.buyer.options.cheminee;
            }

            // Clear buyer to allow re-save
            unit.buyer = null;
            onBuyerUnitChange();
        }

        // ==================== CALCULATIONS ====================
        function calculateTotals(unit) {
            if (!unit.buyer) return { totalAufpreise: 0, gesamtpreis: unit.salePrice };

            const b = unit.buyer;
            const budgets = unit.budgets[b.line];

            // Total budget and costs
            const totalBudget = budgets.boden + budgets.kueche + budgets.sanitaer;
            const totalCost = b.costs.boden + b.costs.kueche + b.costs.sanitaer;

            // Excess across all categories (mit Kulanz-Schwelle)
            const totalExcess = Math.max(0, totalCost - totalBudget);
            const kulanzSchwelle = appData.kulanzSchwelle || 0;
            const kulanzAngewendet = totalExcess > 0 && totalExcess <= kulanzSchwelle;
            const verrechneteExcess = kulanzAngewendet ? 0 : totalExcess;
            const surcharge = Math.round(verrechneteExcess * SURCHARGE_RATE);
            const excessWithSurcharge = verrechneteExcess + surcharge;

            // Premium upgrade Details (f√ºr Aufschl√ºsselung)
            let premiumUpgrade = 0;
            let premiumDetails = { budgetDiff: 0, betreuung: 0, elektro: 0, weissputz: 0, blockfutter: 0 };
            if (b.line === 'premium') {
                const basicT = unit.budgets.basic.boden + unit.budgets.basic.kueche + unit.budgets.basic.sanitaer;
                const premT = unit.budgets.premium.boden + unit.budgets.premium.kueche + unit.budgets.premium.sanitaer;
                premiumDetails.budgetDiff = Math.max(0, premT - basicT);
                premiumDetails.betreuung = appData.premiumBetreuung || 0;
                premiumDetails.elektro = Math.round((appData.premiumElektro || 0) * (unit.zimmer || 0));
                // Weissputz + Blockfutter bei Premium automatisch inklusive
                premiumDetails.weissputz = (unit.verputzM2 || 0) * (appData.optionPrices.weissputz || 0);
                premiumDetails.blockfutter = (unit.tueren || 0) * (appData.optionPrices.blockfutter || 0);
                premiumUpgrade = premiumDetails.budgetDiff + premiumDetails.betreuung + premiumDetails.elektro + premiumDetails.weissputz + premiumDetails.blockfutter;
            }

            // Options (Sonos pro Zimmer berechnet)
            let optionsTotal = 0;
            const zimmer = unit.zimmer || 0;
            if (b.options.sonos && appData.optionPrices.sonos) optionsTotal += Math.round(appData.optionPrices.sonos * zimmer);
            // Elektro/Weissputz/Blockfutter bei Basic als Option (mit 30% Aufschlag)
            const BASIC_OPTION_SURCHARGE = 1.30;  // 30% Aufschlag bei Basic
            if (b.line === 'basic') {
                if (b.options.elektro && appData.premiumElektro) {
                    optionsTotal += Math.round((appData.premiumElektro * zimmer) * BASIC_OPTION_SURCHARGE);
                }
                if (b.options.weissputz && appData.optionPrices.weissputz) {
                    optionsTotal += Math.round((unit.verputzM2 || 0) * appData.optionPrices.weissputz * BASIC_OPTION_SURCHARGE);
                }
                if (b.options.blockfutter && appData.optionPrices.blockfutter) {
                    optionsTotal += Math.round((unit.tueren || 0) * appData.optionPrices.blockfutter * BASIC_OPTION_SURCHARGE);
                }
            }
            // Einbauschrank-Option (mit 20% Aufschlag - f√ºr Basic und Premium)
            const EINBAUSCHRANK_SURCHARGE = 1.20;
            if (b.options.einbauschrank && b.options.einbauschrank > 0 && appData.optionPrices.einbauschrank) {
                optionsTotal += Math.round(b.options.einbauschrank * appData.optionPrices.einbauschrank * EINBAUSCHRANK_SURCHARGE);
            }
            if (unit.isAttika) {
                if (b.options.whirlpool && appData.optionPrices.whirlpool) optionsTotal += appData.optionPrices.whirlpool;
                if (b.options.cheminee && appData.optionPrices.cheminee) optionsTotal += appData.optionPrices.cheminee;
            }
            // E-Ladestation Option (ohne Aufschlag)
            if (b.options.eladestation && b.options.eladestation > 0 && appData.optionPrices.eladestation) {
                optionsTotal += b.options.eladestation * appData.optionPrices.eladestation;
            }

            // Parkpl√§tze: Pflicht-PP aus CSV + Zusatz-PP aus K√§ufer-Optionen
            const pflichtPPAnzahl = unit.parkplaetze || 0;
            const pflichtPPTotal = pflichtPPAnzahl * (appData.parkplatzPreis || 0);
            const zusatzPPAnzahl = b.zusatzparkplaetze || 0;
            const zusatzPPTotal = zusatzPPAnzahl * (appData.zusatzparkplatzPreis || 0);
            const bastelraeumeAnzahl = b.bastelraeume || 0;
            const bastelraeumeTotal = bastelraeumeAnzahl * (appData.bastelraumPreis || 0);
            const nebenraeumeTotal = pflichtPPTotal + zusatzPPTotal + bastelraeumeTotal;

            const totalAufpreise = premiumUpgrade + excessWithSurcharge + optionsTotal;
            const gesamtpreisUngerundet = unit.salePrice + totalAufpreise + nebenraeumeTotal;

            // Abrundung auf 1000 genau
            const rundung = gesamtpreisUngerundet % 1000;
            const gesamtpreis = gesamtpreisUngerundet - rundung;

            return {
                totalBudget, totalCost, totalExcess, kulanzAngewendet, verrechneteExcess,
                surcharge, excessWithSurcharge, premiumUpgrade, premiumDetails,
                optionsTotal, pflichtPPAnzahl, pflichtPPTotal, zusatzPPAnzahl, zusatzPPTotal,
                bastelraeumeAnzahl, bastelraeumeTotal, nebenraeumeTotal,
                totalAufpreise, gesamtpreisUngerundet, rundung, gesamtpreis
            };
        }

        // ==================== BUYER REPORT ====================
        function populateReportSelect() {
            const select = document.getElementById('report-unit-select');
            const unitsWithBuyer = appData.units.filter(u => u.buyer);
            select.innerHTML = '<option value="">‚Äì Einheit w√§hlen ‚Äì</option>' +
                unitsWithBuyer.map(u => `<option value="${esc(u.id)}">${esc(u.id)} ‚Äì ${esc(u.buyer.name)}</option>`).join('');
        }

        function renderBuyerReport() {
            const unitId = document.getElementById('report-unit-select').value;
            const container = document.getElementById('buyer-report-content');

            if (!unitId) {
                container.innerHTML = '<p style="color: var(--text-muted)" class="text-center py-8">Bitte Einheit ausw√§hlen</p>';
                return;
            }

            const unit = appData.units.find(u => u.id === unitId);
            if (!unit || !unit.buyer) return;

            const calc = calculateTotals(unit);
            const b = unit.buyer;
            const budgets = unit.budgets[b.line];

            const isPremium = b.line === 'premium';

            container.innerHTML = `
                <div class="animate-fade-in space-y-6">
                    <!-- Header mit Premium-Highlight -->
                    ${isPremium ? `
                    <div class="p-4 rounded-xl" style="background: linear-gradient(135deg, var(--premium-light) 0%, rgba(124,58,237,0.2) 100%); border: 2px solid var(--premium)">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="text-3xl">‚≠ê</div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold" style="color: var(--premium)">${esc(unit.id)}</h3>
                                <p class="font-medium">${esc(b.name)}</p>
                            </div>
                            <div class="text-right">
                                <span class="badge px-3 py-1 text-sm font-bold" style="background: var(--premium); color: white">
                                    ‚≠ê PREMIUM KUNDE
                                </span>
                                <p class="text-xs mt-1" style="color: var(--text-muted)">${esc(getTypeLabel(unit))} ¬∑ ${unit.bodenM2} m¬≤</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 grid grid-cols-3 gap-2 text-xs" style="border-top: 1px solid var(--premium)">
                            <div class="text-center">
                                <span style="color: var(--premium)">‚úì</span> Pers&ouml;nliche Betreuung
                            </div>
                            <div class="text-center">
                                <span style="color: var(--premium)">‚úì</span> H&ouml;heres Budget
                            </div>
                            <div class="text-center">
                                <span style="color: var(--premium)">‚úì</span> Elektro-Upgrade
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="flex flex-wrap items-center gap-4 pb-4" style="border-bottom: 1px solid var(--border-color)">
                        <div>
                            <h3 class="text-xl font-bold">${esc(unit.id)}</h3>
                            <p style="color: var(--text-secondary)">${esc(b.name)}</p>
                        </div>
                        <span class="badge" style="background: #dbeafe; color: #1e40af">
                            Basic
                        </span>
                        <span class="text-sm" style="color: var(--text-muted)">${esc(getTypeLabel(unit))} ¬∑ ${unit.bodenM2} m¬≤</span>
                    </div>
                    `}

                    <div class="card rounded-lg p-4" style="background: var(--bg-tertiary)">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Verkaufspreis</span>
                            <span class="text-xl font-bold num">${formatCHF(unit.salePrice)}</span>
                        </div>
                    </div>

                    ${calc.premiumUpgrade > 0 ? `
                    <div class="card rounded-lg p-4" style="background: var(--premium-light); border-left: 4px solid var(--premium)">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium" style="color: var(--premium)">‚≠ê Premium inklusive</p>
                                <p class="text-xs" style="color: var(--text-muted)">H&ouml;heres Budget, Betreuung &amp; Elektro-Upgrade</p>
                            </div>
                            <span class="text-lg font-bold num" style="color: var(--premium)">+${formatCHF(calc.premiumUpgrade)}</span>
                        </div>
                    </div>` : ''}

                    <div>
                        <h4 class="font-medium mb-3">Ausstattungskosten</h4>
                        <table class="w-full text-sm">
                            <thead><tr class="table-header">
                                <th class="text-left p-3 rounded-tl-lg">Gruppe</th>
                                <th class="text-right p-3">Budget</th>
                                <th class="text-right p-3 rounded-tr-lg">Auswahl</th>
                            </tr></thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-color)">
                                    <td class="p-3">Boden-/Wandbel√§ge</td>
                                    <td class="p-3 text-right num">${formatCHF(budgets.boden)}</td>
                                    <td class="p-3 text-right num">${formatCHF(b.costs.boden)}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color)">
                                    <td class="p-3">K√ºche</td>
                                    <td class="p-3 text-right num">${formatCHF(budgets.kueche)}</td>
                                    <td class="p-3 text-right num">${formatCHF(b.costs.kueche)}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color)">
                                    <td class="p-3">Sanit√§r</td>
                                    <td class="p-3 text-right num">${formatCHF(budgets.sanitaer)}</td>
                                    <td class="p-3 text-right num">${formatCHF(b.costs.sanitaer)}</td>
                                </tr>
                                <tr class="table-header font-medium">
                                    <td class="p-3 rounded-bl-lg">Gesamt</td>
                                    <td class="p-3 text-right num">${formatCHF(calc.totalBudget)}</td>
                                    <td class="p-3 text-right num rounded-br-lg">${formatCHF(calc.totalCost)}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="mt-4 p-4 rounded-lg ${calc.totalExcess > 0 && !calc.kulanzAngewendet ? 'over-budget' : 'in-budget'}">
                            ${calc.kulanzAngewendet ? `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span>√úberschreitung</span>
                                        <span class="badge ml-2" style="background: #dcfce7; color: #166534">Kulanz</span>
                                    </div>
                                    <span class="num" style="text-decoration: line-through; color: var(--text-muted)">${formatCHF(calc.totalExcess)}</span>
                                </div>
                                <p class="text-sm mt-2" style="color: var(--accent)">‚úì Unter Kulanz-Schwelle (${formatCHF(appData.kulanzSchwelle)}) ‚Äì nicht verrechnet</p>
                            ` : calc.totalExcess > 0 ? `
                                <div class="flex justify-between"><span>√úberschreitung</span><span class="num" style="color: var(--danger)">${formatCHF(calc.totalExcess)}</span></div>
                                <div class="flex justify-between mt-1"><span class="text-sm">+ 20% Zuschlag</span><span class="num">${formatCHF(calc.surcharge)}</span></div>
                                <div class="flex justify-between mt-2 pt-2 font-medium" style="border-top: 1px solid var(--border-color)">
                                    <span>Aufpreis √úberschreitung</span><span class="num" style="color: var(--danger)">+${formatCHF(calc.excessWithSurcharge)}</span>
                                </div>
                            ` : '<p class="text-center" style="color: var(--accent)">‚úì Im Budget ‚Äì kein Aufpreis</p>'}
                        </div>
                    </div>

                    ${b.line === 'premium' ? `
                    <div>
                        <h4 class="font-medium mb-3">Im Premium inklusive</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--premium-light)">
                                <span>‚ö° Erweiterte Elektroinstallation</span>
                                <span class="text-sm" style="color: var(--premium)">inklusive</span>
                            </div>
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--premium-light)">
                                <span>üé® Weissputzw√§nde</span>
                                <span class="text-sm" style="color: var(--premium)">inklusive</span>
                            </div>
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--premium-light)">
                                <span>üö™ Blockfuttert√ºren</span>
                                <span class="text-sm" style="color: var(--premium)">inklusive</span>
                            </div>
                        </div>
                    </div>` : ''}

                    ${calc.optionsTotal > 0 ? `
                    <div>
                        <h4 class="font-medium mb-3">Zusatzoptionen</h4>
                        <div class="space-y-2">
                            ${b.options.sonos && appData.optionPrices.sonos ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üîä Vorb. W-Lan Soundsystem</span>
                                <span class="num font-medium">+${formatCHF(Math.round(appData.optionPrices.sonos * (unit.zimmer || 0)))}</span>
                            </div>` : ''}
                            ${b.options.elektro && appData.premiumElektro && b.line === 'basic' ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>‚ö° Erweiterte Elektroinstallation</span>
                                <span class="num font-medium">+${formatCHF(Math.round(appData.premiumElektro * (unit.zimmer || 0) * 1.30))}</span>
                            </div>` : ''}
                            ${b.options.weissputz && appData.optionPrices.weissputz && b.line === 'basic' ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üé® Weissputzw√§nde</span>
                                <span class="num font-medium">+${formatCHF(Math.round((unit.verputzM2 || 0) * appData.optionPrices.weissputz * 1.30))}</span>
                            </div>` : ''}
                            ${b.options.blockfutter && appData.optionPrices.blockfutter && b.line === 'basic' ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üö™ Blockfuttert&uuml;ren</span>
                                <span class="num font-medium">+${formatCHF(Math.round((unit.tueren || 0) * appData.optionPrices.blockfutter * 1.30))}</span>
                            </div>` : ''}
                            ${b.options.einbauschrank && b.options.einbauschrank > 0 && appData.optionPrices.einbauschrank ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üóÑÔ∏è Einbauschr&auml;nke (${b.options.einbauschrank} m')</span>
                                <span class="num font-medium">+${formatCHF(Math.round(b.options.einbauschrank * appData.optionPrices.einbauschrank * 1.20))}</span>
                            </div>` : ''}
                            ${b.options.whirlpool && appData.optionPrices.whirlpool ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üõÅ Whirlpool</span>
                                <span class="num font-medium">+${formatCHF(appData.optionPrices.whirlpool)}</span>
                            </div>` : ''}
                            ${b.options.cheminee && appData.optionPrices.cheminee ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üî• Chemin&eacute;e</span>
                                <span class="num font-medium">+${formatCHF(appData.optionPrices.cheminee)}</span>
                            </div>` : ''}
                            ${b.options.eladestation && b.options.eladestation > 0 && appData.optionPrices.eladestation ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <span>üîå E-Ladestation TG (${b.options.eladestation} Stk.)</span>
                                <span class="num font-medium">+${formatCHF(b.options.eladestation * appData.optionPrices.eladestation)}</span>
                            </div>` : ''}
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-2" style="border-top: 1px solid var(--border-color)">
                            <span class="font-medium">Optionen Total</span>
                            <span class="num font-bold">+${formatCHF(calc.optionsTotal)}</span>
                        </div>
                    </div>` : ''}

                    ${calc.nebenraeumeTotal > 0 ? `
                    <div>
                        <h4 class="font-medium mb-3">Parkpl√§tze & Nebenr√§ume</h4>
                        <div class="space-y-2">
                            ${calc.pflichtPPTotal > 0 ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <div>
                                    <span>Pflicht-Parkpl√§tze</span>
                                    <span class="text-xs ml-2" style="color: var(--text-muted)">${calc.pflichtPPAnzahl} √ó ${formatCHF(appData.parkplatzPreis)}</span>
                                </div>
                                <span class="num font-medium">+${formatCHF(calc.pflichtPPTotal)}</span>
                            </div>` : ''}
                            ${calc.zusatzPPTotal > 0 ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <div>
                                    <span>Zusatzparkpl√§tze</span>
                                    <span class="text-xs ml-2" style="color: var(--text-muted)">${calc.zusatzPPAnzahl} √ó ${formatCHF(appData.zusatzparkplatzPreis)}</span>
                                </div>
                                <span class="num font-medium">+${formatCHF(calc.zusatzPPTotal)}</span>
                            </div>` : ''}
                            ${calc.bastelraeumeTotal > 0 ? `
                            <div class="flex justify-between items-center p-2 rounded-lg" style="background: var(--bg-tertiary)">
                                <div>
                                    <span>Bastelr√§ume</span>
                                    <span class="text-xs ml-2" style="color: var(--text-muted)">${calc.bastelraeumeAnzahl} √ó ${formatCHF(appData.bastelraumPreis)}</span>
                                </div>
                                <span class="num font-medium">+${formatCHF(calc.bastelraeumeTotal)}</span>
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <div class="card rounded-xl p-4" style="background: var(--bg-tertiary)">
                        <table class="w-full text-sm">
                            <tr><td class="py-1">Verkaufspreis</td><td class="py-1 text-right num">${formatCHF(unit.salePrice)}</td></tr>
                            ${calc.premiumUpgrade > 0 ? `<tr><td class="py-1">Premium-Leistungen</td><td class="py-1 text-right num" style="color: var(--premium)">+${formatCHF(calc.premiumUpgrade)}</td></tr>` : ''}
                            ${calc.excessWithSurcharge > 0 ? `<tr><td class="py-1">√úberschreitung + Zuschlag</td><td class="py-1 text-right num" style="color: var(--danger)">+${formatCHF(calc.excessWithSurcharge)}</td></tr>` : ''}
                            ${calc.optionsTotal > 0 ? `<tr><td class="py-1">Optionen</td><td class="py-1 text-right num">+${formatCHF(calc.optionsTotal)}</td></tr>` : ''}
                            ${calc.nebenraeumeTotal > 0 ? `<tr><td class="py-1">Parkpl√§tze & Nebenr√§ume</td><td class="py-1 text-right num">+${formatCHF(calc.nebenraeumeTotal)}</td></tr>` : ''}
                            ${calc.rundung > 0 ? `<tr><td class="py-1" style="color: var(--text-muted)">Rundung</td><td class="py-1 text-right num" style="color: var(--text-muted)">‚àíCHF ${Math.round(calc.rundung).toLocaleString('de-CH')}</td></tr>` : ''}
                            <tr style="border-top: 2px solid var(--border-color)">
                                <td class="py-2 font-bold">Gesamtpreis</td>
                                <td class="py-2 text-right num font-bold text-lg" style="color: var(--accent)">${formatCHF(calc.gesamtpreis)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== PROJECT REPORT ====================
        function renderProjectReport() {
            const unitsWithBuyer = appData.units.filter(u => u.buyer);
            const unitsWithoutBuyer = appData.units.filter(u => !u.buyer);
            const premiumBuyers = unitsWithBuyer.filter(u => u.buyer.line === 'premium');

            // Maximaler Erl√∂s berechnen (alle Einheiten mit Basis-VP + Nebenr√§ume)
            let maxRevenue = 0;
            let totalParkplaetze = 0;
            let totalBastelraeume = 0;
            appData.units.forEach(u => {
                maxRevenue += u.salePrice;
                const pp = u.parkplaetze || 0;
                const br = u.bastelraeume || 0;
                totalParkplaetze += pp;
                totalBastelraeume += br;
                maxRevenue += pp * (appData.parkplatzPreis || 0);
                maxRevenue += br * (appData.bastelraumPreis || 0);
            });

            // Offener Erl√∂s (nicht verkaufte Einheiten)
            let openRevenue = 0;
            unitsWithoutBuyer.forEach(u => {
                openRevenue += u.salePrice;
                openRevenue += (u.parkplaetze || 0) * (appData.parkplatzPreis || 0);
                openRevenue += (u.bastelraeume || 0) * (appData.bastelraumPreis || 0);
            });

            let totals = { sales: 0, premium: 0, excess: 0, surcharges: 0, options: 0, nebenraeume: 0, rundung: 0, total: 0 };
            let premiumTotals = { budgetDiff: 0, betreuung: 0, elektro: 0, total: 0 };

            unitsWithBuyer.forEach(u => {
                const calc = calculateTotals(u);
                totals.sales += u.salePrice;
                totals.premium += calc.premiumUpgrade;
                totals.excess += calc.excessWithSurcharge;
                totals.surcharges += calc.surcharge; // Nur der 20%-Zuschlag
                totals.options += calc.optionsTotal;
                totals.nebenraeume += calc.nebenraeumeTotal;
                totals.rundung += calc.rundung;
                totals.total += calc.gesamtpreis;

                if (u.buyer.line === 'premium') {
                    premiumTotals.budgetDiff += calc.premiumDetails.budgetDiff;
                    premiumTotals.betreuung += calc.premiumDetails.betreuung;
                    premiumTotals.elektro += calc.premiumDetails.elektro;
                    premiumTotals.total += calc.premiumUpgrade;
                }
            });

            // Max Erl√∂s √úbersicht
            document.getElementById('stat-max-revenue').textContent = formatCHF(maxRevenue);
            document.getElementById('stat-max-units').textContent = appData.units.length;
            document.getElementById('stat-max-pp').textContent = totalParkplaetze;
            document.getElementById('stat-max-br').textContent = totalBastelraeume;

            // Realisierter Erl√∂s
            document.getElementById('stat-total').textContent = formatCHF(totals.total);
            document.getElementById('stat-buyers').textContent = unitsWithBuyer.length;
            const soldPercent = appData.units.length > 0 ? Math.round((unitsWithBuyer.length / appData.units.length) * 100) : 0;
            document.getElementById('stat-sold-percent').textContent = soldPercent;

            // Offener Erl√∂s
            document.getElementById('stat-open-revenue').textContent = formatCHF(openRevenue);
            document.getElementById('stat-open-units').textContent = unitsWithoutBuyer.length;

            // Detail-Statistiken
            document.getElementById('stat-sales').textContent = formatCHF(totals.sales);
            document.getElementById('stat-nebenraeume').textContent = formatCHF(totals.nebenraeume);
            document.getElementById('stat-premium').textContent = formatCHF(totals.premium);
            // Premium-Details im Statistik-Kachel
            const premiumDetailsEl = document.getElementById('stat-premium-details');
            if (totals.premium > 0) {
                premiumDetailsEl.innerHTML = `
                    <div class="flex justify-between"><span>Budgets</span><span class="num">${formatCHF(premiumTotals.budgetDiff)}</span></div>
                    <div class="flex justify-between"><span>Betreuung</span><span class="num">${formatCHF(premiumTotals.betreuung)}</span></div>
                    <div class="flex justify-between"><span>Elektro</span><span class="num">${formatCHF(premiumTotals.elektro)}</span></div>
                `;
            } else {
                premiumDetailsEl.innerHTML = '';
            }
            document.getElementById('stat-options').textContent = formatCHF(totals.options);
            document.getElementById('stat-excess').textContent = formatCHF(totals.excess);
            document.getElementById('stat-rundung').textContent = totals.rundung > 0 ? `‚àíCHF ${Math.round(totals.rundung).toLocaleString('de-CH')}` : '‚àíCHF 0';

            // Gewinnprognose
            const kostenprognose = appData.kostenprognose || 0;
            const gewinn = maxRevenue - kostenprognose;

            document.getElementById('stat-prognose-max').textContent = formatCHF(maxRevenue);
            document.getElementById('stat-kostenprognose').textContent = kostenprognose > 0 ? `‚àí${formatCHF(kostenprognose)}` : 'CHF 0';
            document.getElementById('stat-gewinn').textContent = formatCHF(gewinn);
            document.getElementById('stat-gewinn').style.color = gewinn >= 0 ? 'var(--accent)' : 'var(--danger)';

            // Entwicklerhonorar = 20%-Zuschl√§ge auf √úberschreitungen + Betreuungspauschalen
            const entwicklerhonorar = totals.surcharges + premiumTotals.betreuung;
            document.getElementById('stat-entwicklerhonorar').textContent = formatCHF(entwicklerhonorar);

            const ehDetailsEl = document.getElementById('entwicklerhonorar-details');
            ehDetailsEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <span style="color: var(--text-secondary)">√úberschreitungszuschl√§ge (20%)</span>
                    <span class="num font-medium">${formatCHF(totals.surcharges)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <span style="color: var(--text-secondary)">Betreuungspauschalen</span>
                        ${premiumBuyers.length > 0 ? `<span class="text-xs ml-1" style="color: var(--text-muted)">(${premiumBuyers.length}√ó Premium)</span>` : ''}
                    </div>
                    <span class="num font-medium">${formatCHF(premiumTotals.betreuung)}</span>
                </div>
            `;

            const tbody = document.getElementById('project-report-body');
            if (unitsWithBuyer.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center" style="color: var(--text-muted)">Keine K√§ufer erfasst</td></tr>';
                document.getElementById('premium-breakdown').innerHTML = '<p class="text-center py-4" style="color: var(--text-muted)">Keine Premium-K√§ufer</p>';
                document.getElementById('entwicklerhonorar-details').innerHTML = '<p style="color: var(--text-muted)">Noch keine Zuschl√§ge erfasst</p>';
                return;
            }

            tbody.innerHTML = unitsWithBuyer.map(u => {
                const calc = calculateTotals(u);
                return `<tr style="border-bottom: 1px solid var(--border-color)">
                    <td class="p-3 font-medium">${esc(u.id)}</td>
                    <td class="p-3">${esc(u.buyer.name)}</td>
                    <td class="p-3 text-center">
                        <span class="badge" style="background: ${u.buyer.line === 'premium' ? '#f3e8ff' : '#dbeafe'}; color: ${u.buyer.line === 'premium' ? '#7c3aed' : '#1e40af'}">
                            ${u.buyer.line === 'premium' ? 'P' : 'B'}
                        </span>
                    </td>
                    <td class="p-3 text-right num">${formatCHF(u.salePrice)}</td>
                    <td class="p-3 text-right num" style="color: ${calc.totalAufpreise > 0 ? 'var(--danger)' : 'var(--text-muted)'}">
                        ${calc.totalAufpreise > 0 ? '+' + formatCHF(calc.totalAufpreise) : '‚Äì'}
                    </td>
                    <td class="p-3 text-right num font-semibold">${formatCHF(calc.gesamtpreis)}</td>
                </tr>`;
            }).join('');

            // Premium breakdown
            const breakdownEl = document.getElementById('premium-breakdown');
            if (premiumBuyers.length === 0) {
                breakdownEl.innerHTML = '<p class="text-center py-4" style="color: var(--text-muted)">Keine Premium-K√§ufer</p>';
            } else {
                breakdownEl.innerHTML = `
                    <div class="text-sm mb-4" style="color: var(--text-muted)">${premiumBuyers.length} Premium-K√§ufer</div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 rounded-lg" style="background: rgba(124,58,237,0.15)">
                            <span>Budget-Differenz (Basic ‚Üí Premium)</span>
                            <span class="num font-semibold">${formatCHF(premiumTotals.budgetDiff)}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg" style="background: rgba(124,58,237,0.15)">
                            <div>
                                <span>K√§uferbetreuung</span>
                                <span class="text-xs ml-2" style="color: var(--text-muted)">${premiumBuyers.length} √ó ${formatCHF(appData.premiumBetreuung)}</span>
                            </div>
                            <span class="num font-semibold">${formatCHF(premiumTotals.betreuung)}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg" style="background: rgba(124,58,237,0.15)">
                            <div>
                                <span>Elektroinstallationen</span>
                                <span class="text-xs ml-2" style="color: var(--text-muted)">${formatCHF(appData.premiumElektro)}/Zi</span>
                            </div>
                            <span class="num font-semibold">${formatCHF(premiumTotals.elektro)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4 pt-3" style="border-top: 2px solid var(--premium)">
                        <span class="font-semibold" style="color: var(--premium)">Premium-Leistungen Total</span>
                        <span class="text-xl num font-bold" style="color: var(--premium)">${formatCHF(premiumTotals.total)}</span>
                    </div>
                `;
            }
        }

        // ==================== IMPORT/EXPORT ====================
        function exportData() {
            const data = JSON.stringify({ exportDate: new Date().toISOString(), ...appData }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kaeuferbetreuung_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export erfolgreich ‚úì');
        }

        function exportForKonfigurator() {
            // Alle Einheiten exportieren, mit buyer-Flag f√ºr reservierte
            const allUnits = appData.units.map(u => ({
                id: u.id,
                typ: u.typ,
                zimmer: u.zimmer,
                salePrice: u.salePrice,
                bodenM2: u.bodenM2,
                plattenM2: u.plattenM2,
                verputzM2: u.verputzM2,
                tueren: u.tueren,
                parkplaetze: u.parkplaetze,
                isAttika: u.isAttika,
                budgets: u.budgets,
                buyer: u.buyer ? true : false  // Nur ob reserviert, nicht die K√§uferdaten
            }));

            const availableCount = allUnits.filter(u => !u.buyer).length;
            const reservedCount = allUnits.filter(u => u.buyer).length;

            const konfigData = {
                exportDate: new Date().toISOString(),
                optionPrices: appData.optionPrices,
                premiumBetreuung: appData.premiumBetreuung,
                premiumElektro: appData.premiumElektro,
                parkplatzPreis: appData.parkplatzPreis,
                zusatzparkplatzPreis: appData.zusatzparkplatzPreis,
                bastelraumPreis: appData.bastelraumPreis,
                units: allUnits
            };

            const data = JSON.stringify(konfigData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'konfigurator-daten.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Konfigurator-Export: ${availableCount} verf√ºgbar, ${reservedCount} reserviert ‚úì`);
        }

        function showImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('import-modal').classList.add('flex');
        }

        function hideImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('import-modal').classList.remove('flex');
        }

        function importData() {
            try {
                const data = JSON.parse(document.getElementById('import-data').value.trim());
                if (data.optionPrices) appData.optionPrices = data.optionPrices;
                if (data.premiumBetreuung !== undefined) appData.premiumBetreuung = data.premiumBetreuung;
                if (data.premiumElektro !== undefined) appData.premiumElektro = data.premiumElektro;
                if (data.kulanzSchwelle !== undefined) appData.kulanzSchwelle = data.kulanzSchwelle;
                if (data.parkplatzPreis !== undefined) appData.parkplatzPreis = data.parkplatzPreis;
                if (data.zusatzparkplatzPreis !== undefined) appData.zusatzparkplatzPreis = data.zusatzparkplatzPreis;
                if (data.bastelraumPreis !== undefined) appData.bastelraumPreis = data.bastelraumPreis;
                if (data.kostenprognose !== undefined) appData.kostenprognose = data.kostenprognose;
                if (data.units) appData.units = data.units;
                loadSettings();
                renderUnitsTable();
                hideImportModal();
                showToast('Import erfolgreich ‚úì');
            } catch (e) {
                showToast('Ung√ºltiges JSON', 'error');
            }
        }

        // ==================== UTILITIES ====================
        function formatCHF(amount) {
            if (amount === null || amount === undefined) return '‚Äì';
            return `CHF ${Math.round(amount).toLocaleString('de-CH')}`;
        }

        function esc(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.style.background = type === 'error' ? 'var(--danger)' : 'var(--accent)';
            document.getElementById('toast-message').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function showConfirmDialog(msg, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-backdrop';
            modal.innerHTML = `
                <div class="card rounded-xl p-6 max-w-sm w-full mx-4 animate-fade-in">
                    <p class="mb-4">${msg}</p>
                    <div class="flex justify-end gap-3">
                        <button class="cancel px-4 py-2 rounded-lg btn-secondary">Abbrechen</button>
                        <button class="confirm px-4 py-2 rounded-lg" style="background: var(--danger); color: white">L√∂schen</button>
                    </div>
                </div>
            `;
            modal.querySelector('.cancel').onclick = () => modal.remove();
            modal.querySelector('.confirm').onclick = () => { modal.remove(); onConfirm(); };
            document.body.appendChild(modal);
        }

        // ==================== KONFIGURATOR ====================
        let configState = { unitId: null, line: null };

        function populateConfigUnitSelect() {
            const select = document.getElementById('config-unit-select');
            // Alle Einheiten anzeigen, reservierte als disabled markieren
            select.innerHTML = '<option value="">‚Äì Bitte Wohnung ausw√§hlen ‚Äì</option>' +
                appData.units.map(u => {
                    // Bei Attika: Premium bereits im VP integriert, sonst nur Basispreis
                    let displayPrice = u.salePrice;
                    if (u.isAttika) {
                        displayPrice += calculatePremiumUpgrade(u);
                    }
                    const isReserved = !!u.buyer;
                    const reservedText = isReserved ? ' ‚Äì RESERVIERT' : '';
                    return `<option value="${esc(u.id)}" ${isReserved ? 'disabled style="color: #999; background: #f0f0f0;"' : ''}>${esc(u.id)} ‚Äì ${getTypeLabel(u)} ‚Äì ${formatCHF(displayPrice)}${u.isAttika ? ' ‚≠ê' : ''}${reservedText}</option>`;
                }).join('');
        }

        function updateConfigurator() {
            const unitId = document.getElementById('config-unit-select').value;
            configState.unitId = unitId;
            configState.line = null;

            const infoEl = document.getElementById('config-unit-info');
            const stepLine = document.getElementById('config-step-line');
            const stepOptions = document.getElementById('config-step-options');
            const stepSummary = document.getElementById('config-step-summary');
            const stepSubmit = document.getElementById('config-step-submit');
            const attikaNotice = document.getElementById('config-attika-notice');
            const lineOptions = document.getElementById('config-line-options');
            const attikaOpts = document.getElementById('config-attika-options');

            if (!unitId) {
                infoEl.classList.add('hidden');
                stepLine.classList.add('hidden');
                stepOptions.classList.add('hidden');
                stepSummary.classList.add('hidden');
                stepSubmit.classList.add('hidden');
                return;
            }

            const unit = appData.units.find(u => u.id === unitId);
            if (!unit) return;

            // Bei Attika: Premium bereits im VP integriert
            const premiumUpgrade = calculatePremiumUpgrade(unit);
            const displayPrice = unit.isAttika ? unit.salePrice + premiumUpgrade : unit.salePrice;
            const pflichtPP = unit.parkplaetze || 0;
            const pflichtPPPreis = pflichtPP * (appData.parkplatzPreis || 0);

            infoEl.classList.remove('hidden');
            infoEl.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-xs" style="color: var(--text-muted)">Typ</p>
                        <p class="font-semibold">${esc(getTypeLabel(unit))}</p>
                    </div>
                    <div>
                        <p class="text-xs" style="color: var(--text-muted)">Zimmer</p>
                        <p class="font-semibold">${unit.zimmer || '‚Äì'}</p>
                    </div>
                    <div>
                        <p class="text-xs" style="color: var(--text-muted)">Fl√§che</p>
                        <p class="font-semibold">${unit.bodenM2} m¬≤</p>
                    </div>
                    <div>
                        <p class="text-xs" style="color: var(--text-muted)">Verkaufspreis</p>
                        <p class="font-semibold num" style="color: var(--accent)">${formatCHF(displayPrice)}</p>
                    </div>
                </div>
            `;

            // Step 2: Line ausw√§hlen
            stepLine.classList.remove('hidden');

            // Premium-Preis anzeigen (nicht bei Attika, da bereits im VP integriert)
            if (unit.isAttika) {
                document.getElementById('config-premium-price').textContent = 'inkl.';
            } else {
                document.getElementById('config-premium-price').textContent = `+${formatCHF(premiumUpgrade)}`;
            }

            // Budgets f√ºr Basic und Premium anzeigen
            const basicBudgets = unit.budgets?.basic || { boden: 0, kueche: 0, sanitaer: 0 };
            const premiumBudgets = unit.budgets?.premium || { boden: 0, kueche: 0, sanitaer: 0 };
            const bodenWandM2 = (unit.bodenM2 || 0) + (unit.plattenM2 || 0);  // F√ºr Budget-Berechnung (ohne Verputz)

            document.getElementById('config-basic-boden').textContent = formatCHF(basicBudgets.boden);
            document.getElementById('config-basic-kueche').textContent = formatCHF(basicBudgets.kueche);
            document.getElementById('config-basic-sanitaer').textContent = formatCHF(basicBudgets.sanitaer);

            document.getElementById('config-premium-boden').textContent = formatCHF(premiumBudgets.boden);
            document.getElementById('config-premium-kueche').textContent = formatCHF(premiumBudgets.kueche);
            document.getElementById('config-premium-sanitaer').textContent = formatCHF(premiumBudgets.sanitaer);

            // Preis pro m¬≤ anzeigen (nur Boden + Platten)
            if (bodenWandM2 > 0) {
                const basicM2 = Math.round(basicBudgets.boden / bodenWandM2);
                const premiumM2 = Math.round(premiumBudgets.boden / bodenWandM2);
                document.getElementById('config-basic-boden-m2').textContent = `(${basicM2} CHF/m¬≤)`;
                document.getElementById('config-premium-boden-m2').textContent = `(${premiumM2} CHF/m¬≤)`;
            } else {
                document.getElementById('config-basic-boden-m2').textContent = '';
                document.getElementById('config-premium-boden-m2').textContent = '';
            }

            // Bei Attika: Premium erzwingen
            if (unit.isAttika) {
                attikaNotice.classList.remove('hidden');
                lineOptions.style.opacity = '0.5';
                lineOptions.style.pointerEvents = 'none';
                configState.line = 'premium';
                selectConfigLine('premium', true);
            } else {
                attikaNotice.classList.add('hidden');
                lineOptions.style.opacity = '1';
                lineOptions.style.pointerEvents = 'auto';
                // Reset line selection
                document.getElementById('config-line-basic').style.borderColor = 'var(--border-color)';
                document.getElementById('config-line-basic').style.background = '';
                document.getElementById('config-line-premium').style.borderColor = 'var(--border-color)';
                document.getElementById('config-line-premium').style.background = '';
            }

            // Attika-Optionen
            if (unit.isAttika) {
                attikaOpts.classList.remove('hidden');
            } else {
                attikaOpts.classList.add('hidden');
                document.getElementById('config-opt-whirlpool').checked = false;
                document.getElementById('config-opt-cheminee').checked = false;
            }

            // Pflicht-PP
            document.getElementById('config-pflicht-pp').textContent = pflichtPP;
            document.getElementById('config-pflicht-pp-preis').textContent = pflichtPP > 0 ? formatCHF(pflichtPPPreis) : 'inkl.';

            // Preise f√ºr Optionen
            const zimmer = unit.zimmer || 0;
            const sonosPreis = (appData.optionPrices.sonos || 0) * zimmer;
            document.getElementById('config-sonos-preis').textContent = sonosPreis > 0 ? `+${formatCHF(sonosPreis)}` : '‚Äì';
            // Tooltips aus Beschreibungen setzen
            if (appData.optionDescriptions.sonos) {
                document.getElementById('config-sonos-label').title = appData.optionDescriptions.sonos;
                document.getElementById('config-sonos-desc').textContent = appData.optionDescriptions.sonos;
            }
            document.getElementById('config-whirlpool-preis').textContent = appData.optionPrices.whirlpool ? `+${formatCHF(appData.optionPrices.whirlpool)}` : '‚Äì';
            document.getElementById('config-cheminee-preis').textContent = appData.optionPrices.cheminee ? `+${formatCHF(appData.optionPrices.cheminee)}` : '‚Äì';

            // Tooltips und Beschreibungen f&uuml;r alle Optionen setzen
            const optDescriptions = [
                { label: 'config-elektro-label', desc: 'config-elektro-desc', key: 'elektro' },
                { label: 'config-weissputz-label', desc: 'config-weissputz-desc', key: 'weissputz' },
                { label: 'config-blockfutter-label', desc: 'config-blockfutter-desc', key: 'blockfutter' },
                { label: 'config-einbauschrank-label', desc: 'config-einbauschrank-desc', key: 'einbauschrank' },
                { label: 'config-eladestation-label', desc: 'config-eladestation-desc', key: 'eladestation' },
                { label: 'config-whirlpool-label', desc: 'config-whirlpool-desc', key: 'whirlpool' },
                { label: 'config-cheminee-label', desc: 'config-cheminee-desc', key: 'cheminee' }
            ];
            optDescriptions.forEach(opt => {
                const labelEl = document.getElementById(opt.label);
                const descEl = document.getElementById(opt.desc);
                const text = appData.optionDescriptions[opt.key] || '';
                if (labelEl) labelEl.title = text;
                if (descEl && text) descEl.textContent = text;
            });
            document.getElementById('config-zusatzpp-preis').textContent = `je ${formatCHF(appData.zusatzparkplatzPreis || 0)}`;
            document.getElementById('config-bastelraum-preis').textContent = `je ${formatCHF(appData.bastelraumPreis || 0)}`;

            // Elektro/Weissputz/Blockfutter Preise und Sichtbarkeit (mit 30% Aufschlag bei Basic)
            const BASIC_OPTION_SURCHARGE = 1.30;  // 30% Aufschlag bei Basic
            const verputzM2 = unit.verputzM2 || 0;
            const tueren = unit.tueren || 0;

            // Elektro-Option (mit 30% Aufschlag)
            const elektroPreis = Math.round((appData.premiumElektro || 0) * zimmer * BASIC_OPTION_SURCHARGE);
            document.getElementById('config-zimmer-anzahl').textContent = zimmer;
            document.getElementById('config-elektro-preis').textContent = `+${formatCHF(elektroPreis)}`;

            // Weissputz-Preis (mit 30% Aufschlag)
            const weissputzPreis = Math.round(verputzM2 * (appData.optionPrices.weissputz || 0) * BASIC_OPTION_SURCHARGE);
            const blockfutterPreis = Math.round(tueren * (appData.optionPrices.blockfutter || 0) * BASIC_OPTION_SURCHARGE);

            // Weissputz - immer anzeigen, Preis anpassen
            document.getElementById('config-verputz-m2').textContent = verputzM2;
            document.getElementById('config-weissputz-preis').textContent = weissputzPreis > 0 ? `+${formatCHF(weissputzPreis)}` : '‚Äì';

            // Blockfutter - immer anzeigen, Preis anpassen
            document.getElementById('config-tueren-anzahl').textContent = tueren;
            document.getElementById('config-blockfutter-preis').textContent = blockfutterPreis > 0 ? `+${formatCHF(blockfutterPreis)}` : '‚Äì';

            // Einbauschrank - Preis pro m' anzeigen (20% Aufschlag)
            const EINBAUSCHRANK_SURCHARGE_DISPLAY = 1.20;
            const einbauschankPreisProMeter = Math.round((appData.optionPrices.einbauschrank || 0) * EINBAUSCHRANK_SURCHARGE_DISPLAY);
            document.getElementById('config-einbauschrank-preis').textContent = einbauschankPreisProMeter > 0 ? `${formatCHF(einbauschankPreisProMeter)}/m'` : '‚Äì';

            // E-Ladestation - Preis pro St√ºck anzeigen
            document.getElementById('config-eladestation-preis').textContent = appData.optionPrices.eladestation ? `${formatCHF(appData.optionPrices.eladestation)}/Stk.` : '‚Äì';

            // Reset Optionen
            document.getElementById('config-zusatzpp').value = 0;
            document.getElementById('config-bastelraum').value = 0;
            document.getElementById('config-opt-sonos').checked = false;
            document.getElementById('config-opt-elektro').checked = false;
            document.getElementById('config-opt-weissputz').checked = false;
            document.getElementById('config-opt-blockfutter').checked = false;
            document.getElementById('config-opt-einbauschrank-lfm').value = 0;
            document.getElementById('config-opt-eladestation').value = 0;
            document.getElementById('config-opt-whirlpool').checked = false;
            document.getElementById('config-opt-cheminee').checked = false;

            updateConfigPrice();
        }

        function calculatePremiumUpgrade(unit) {
            const basicT = unit.budgets.basic.boden + unit.budgets.basic.kueche + unit.budgets.basic.sanitaer;
            const premT = unit.budgets.premium.boden + unit.budgets.premium.kueche + unit.budgets.premium.sanitaer;
            const budgetDiff = Math.max(0, premT - basicT);
            const betreuung = appData.premiumBetreuung || 0;
            const elektro = Math.round((appData.premiumElektro || 0) * (unit.zimmer || 0));
            // Weissputz + Blockfutter automatisch bei Premium
            const weissputz = (unit.verputzM2 || 0) * (appData.optionPrices.weissputz || 0);
            const blockfutter = (unit.tueren || 0) * (appData.optionPrices.blockfutter || 0);
            return budgetDiff + betreuung + elektro + weissputz + blockfutter;
        }

        function getPremiumDetails(unit) {
            const basicT = unit.budgets.basic.boden + unit.budgets.basic.kueche + unit.budgets.basic.sanitaer;
            const premT = unit.budgets.premium.boden + unit.budgets.premium.kueche + unit.budgets.premium.sanitaer;
            const budgetDiff = Math.max(0, premT - basicT);
            const betreuung = appData.premiumBetreuung || 0;
            const elektro = Math.round((appData.premiumElektro || 0) * (unit.zimmer || 0));
            const weissputz = (unit.verputzM2 || 0) * (appData.optionPrices.weissputz || 0);
            const blockfutter = (unit.tueren || 0) * (appData.optionPrices.blockfutter || 0);
            return { budgetDiff, betreuung, elektro, weissputz, blockfutter, total: budgetDiff + betreuung + elektro + weissputz + blockfutter };
        }

        function selectConfigLine(line, skipUpdate = false) {
            configState.line = line;

            // Visual feedback
            const basicCard = document.getElementById('config-line-basic');
            const premiumCard = document.getElementById('config-line-premium');
            const basicOptions = document.getElementById('config-basic-options');

            if (line === 'basic') {
                basicCard.style.borderColor = 'var(--accent)';
                basicCard.style.background = 'var(--accent-light)';
                premiumCard.style.borderColor = 'var(--border-color)';
                premiumCard.style.background = '';
                // Bei Basic: Elektro/Weissputz/Blockfutter als Optionen anzeigen
                basicOptions.classList.remove('hidden');
            } else {
                premiumCard.style.borderColor = 'var(--premium)';
                premiumCard.style.background = 'var(--premium-light)';
                basicCard.style.borderColor = 'var(--border-color)';
                basicCard.style.background = '';
                // Bei Premium: Optionen ausblenden (sind inklusive)
                basicOptions.classList.add('hidden');
                document.getElementById('config-opt-elektro').checked = false;
                document.getElementById('config-opt-weissputz').checked = false;
                document.getElementById('config-opt-blockfutter').checked = false;
            }

            // Einbauschrank-Container immer anzeigen (f√ºr Basic und Premium)
            document.getElementById('config-einbauschrank-container').classList.remove('hidden');

            // Show Step 3
            document.getElementById('config-step-options').classList.remove('hidden');
            document.getElementById('config-step-summary').classList.remove('hidden');
            document.getElementById('config-step-submit').classList.remove('hidden');

            if (!skipUpdate) updateConfigPrice();
        }

        function updateConfigPrice() {
            if (!configState.unitId || !configState.line) return;

            const unit = appData.units.find(u => u.id === configState.unitId);
            if (!unit) return;

            // Bei Attika: Premium bereits im VP integriert
            const premiumUpgrade = calculatePremiumUpgrade(unit);
            let basePrice = unit.isAttika ? unit.salePrice + premiumUpgrade : unit.salePrice;

            // Premium-Upgrade nur bei Nicht-Attika separat hinzuf√ºgen
            let premiumExtra = 0;
            if (!unit.isAttika && configState.line === 'premium') {
                premiumExtra = premiumUpgrade;
            }

            // Pflicht-PP
            const pflichtPP = unit.parkplaetze || 0;
            const pflichtPPPreis = pflichtPP * (appData.parkplatzPreis || 0);

            // Zusatz-PP
            const zusatzPP = parseInt(document.getElementById('config-zusatzpp').value) || 0;
            const zusatzPPPreis = zusatzPP * (appData.zusatzparkplatzPreis || 0);

            // Bastelr√§ume
            const bastelraum = parseInt(document.getElementById('config-bastelraum').value) || 0;
            const bastelraumPreis = bastelraum * (appData.bastelraumPreis || 0);

            // Optionen
            const zimmer = unit.zimmer || 0;
            let optionen = 0;
            if (document.getElementById('config-opt-sonos').checked) {
                optionen += (appData.optionPrices.sonos || 0) * zimmer;
            }
            // Elektro + Weissputz + Blockfutter: Bei Basic als Option w√§hlbar (mit 30% Aufschlag), bei Premium automatisch inklusive
            const BASIC_OPTION_SURCHARGE = 1.30;  // 30% Aufschlag bei Basic
            if (configState.line === 'basic') {
                const verputzM2 = unit.verputzM2 || 0;
                const tueren = unit.tueren || 0;
                if (document.getElementById('config-opt-elektro').checked && zimmer > 0) {
                    optionen += Math.round((appData.premiumElektro || 0) * zimmer * BASIC_OPTION_SURCHARGE);
                }
                if (document.getElementById('config-opt-weissputz').checked && verputzM2 > 0) {
                    optionen += Math.round(verputzM2 * (appData.optionPrices.weissputz || 0) * BASIC_OPTION_SURCHARGE);
                }
                if (document.getElementById('config-opt-blockfutter').checked && tueren > 0) {
                    optionen += Math.round(tueren * (appData.optionPrices.blockfutter || 0) * BASIC_OPTION_SURCHARGE);
                }
            }
            // Einbauschrank (immer mit 20% Aufschlag - f√ºr Basic und Premium)
            const EINBAUSCHRANK_SURCHARGE = 1.20;
            const einbauschrank_lfm = parseFloat(document.getElementById('config-opt-einbauschrank-lfm').value) || 0;
            if (einbauschrank_lfm > 0 && appData.optionPrices.einbauschrank) {
                optionen += Math.round(einbauschrank_lfm * appData.optionPrices.einbauschrank * EINBAUSCHRANK_SURCHARGE);
            }
            // E-Ladestation (ohne Aufschlag)
            const eladestation_anzahl = parseInt(document.getElementById('config-opt-eladestation').value) || 0;
            if (eladestation_anzahl > 0 && appData.optionPrices.eladestation) {
                optionen += eladestation_anzahl * appData.optionPrices.eladestation;
            }
            if (unit.isAttika) {
                if (document.getElementById('config-opt-whirlpool').checked) {
                    optionen += appData.optionPrices.whirlpool || 0;
                }
                if (document.getElementById('config-opt-cheminee').checked) {
                    optionen += appData.optionPrices.cheminee || 0;
                }
            }

            // Gesamtpreis
            const totalUnrounded = basePrice + premiumExtra + pflichtPPPreis + zusatzPPPreis + bastelraumPreis + optionen;
            const rundung = totalUnrounded % 1000;
            const total = totalUnrounded - rundung;

            // Summary Details
            const summaryEl = document.getElementById('config-summary-details');
            let summaryHTML = `
                <div class="flex justify-between"><span>Verkaufspreis ${esc(unit.id)}${unit.isAttika ? ' (Premium)' : ''}</span><span class="num">${formatCHF(basePrice)}</span></div>
            `;
            if (premiumExtra > 0) {
                summaryHTML += `<div class="flex justify-between" style="color: var(--premium)"><span>‚≠ê Premium</span><span class="num">+${formatCHF(premiumExtra)}</span></div>`;
            }
            if (pflichtPPPreis > 0) {
                summaryHTML += `<div class="flex justify-between"><span>${pflichtPP}√ó Pflicht-Parkplatz</span><span class="num">+${formatCHF(pflichtPPPreis)}</span></div>`;
            }
            if (zusatzPPPreis > 0) {
                summaryHTML += `<div class="flex justify-between"><span>${zusatzPP}√ó Zusatz-Parkplatz</span><span class="num">+${formatCHF(zusatzPPPreis)}</span></div>`;
            }
            if (bastelraumPreis > 0) {
                summaryHTML += `<div class="flex justify-between"><span>${bastelraum}√ó Bastelraum</span><span class="num">+${formatCHF(bastelraumPreis)}</span></div>`;
            }
            // Einzelne Optionen auflisten
            if (document.getElementById('config-opt-sonos').checked) {
                const sonosPreis = (appData.optionPrices.sonos || 0) * zimmer;
                summaryHTML += `<div class="flex justify-between text-sm"><span>üîä Vorb. W-Lan Soundsystem (${zimmer} Zi)</span><span class="num">+${formatCHF(sonosPreis)}</span></div>`;
            }
            if (configState.line === 'basic') {
                const verputzM2 = unit.verputzM2 || 0;
                const tueren = unit.tueren || 0;
                if (document.getElementById('config-opt-elektro').checked && zimmer > 0) {
                    const elektroPreis = Math.round((appData.premiumElektro || 0) * zimmer * BASIC_OPTION_SURCHARGE);
                    summaryHTML += `<div class="flex justify-between text-sm"><span>‚ö° Elektro (${zimmer} Zi)</span><span class="num">+${formatCHF(elektroPreis)}</span></div>`;
                }
                if (document.getElementById('config-opt-weissputz').checked && verputzM2 > 0) {
                    const weissputzPreis = Math.round(verputzM2 * (appData.optionPrices.weissputz || 0) * BASIC_OPTION_SURCHARGE);
                    summaryHTML += `<div class="flex justify-between text-sm"><span>üé® Weissputz (${verputzM2} m¬≤)</span><span class="num">+${formatCHF(weissputzPreis)}</span></div>`;
                }
                if (document.getElementById('config-opt-blockfutter').checked && tueren > 0) {
                    const blockfutterPreis = Math.round(tueren * (appData.optionPrices.blockfutter || 0) * BASIC_OPTION_SURCHARGE);
                    summaryHTML += `<div class="flex justify-between text-sm"><span>üö™ Blockfutter (${tueren} T&uuml;ren)</span><span class="num">+${formatCHF(blockfutterPreis)}</span></div>`;
                }
            }
            // Einbauschrank in Summary (20% Aufschlag)
            const einbauschrank_lfm_summary = parseFloat(document.getElementById('config-opt-einbauschrank-lfm').value) || 0;
            if (einbauschrank_lfm_summary > 0 && appData.optionPrices.einbauschrank) {
                const einbauschankPreis = Math.round(einbauschrank_lfm_summary * appData.optionPrices.einbauschrank * EINBAUSCHRANK_SURCHARGE);
                summaryHTML += `<div class="flex justify-between text-sm"><span>üóÑÔ∏è Einbauschr&auml;nke (${einbauschrank_lfm_summary} m')</span><span class="num">+${formatCHF(einbauschankPreis)}</span></div>`;
            }
            // E-Ladestation in Summary
            const eladestation_anzahl_summary = parseInt(document.getElementById('config-opt-eladestation').value) || 0;
            if (eladestation_anzahl_summary > 0 && appData.optionPrices.eladestation) {
                const eladestationPreis = eladestation_anzahl_summary * appData.optionPrices.eladestation;
                summaryHTML += `<div class="flex justify-between text-sm"><span>üîå E-Ladestation TG (${eladestation_anzahl_summary} Stk.)</span><span class="num">+${formatCHF(eladestationPreis)}</span></div>`;
            }
            if (unit.isAttika) {
                if (document.getElementById('config-opt-whirlpool').checked) {
                    summaryHTML += `<div class="flex justify-between text-sm"><span>üõÅ Whirlpool</span><span class="num">+${formatCHF(appData.optionPrices.whirlpool)}</span></div>`;
                }
                if (document.getElementById('config-opt-cheminee').checked) {
                    summaryHTML += `<div class="flex justify-between text-sm"><span>üî• Chemin√©e</span><span class="num">+${formatCHF(appData.optionPrices.cheminee)}</span></div>`;
                }
            }
            if (rundung > 0) {
                summaryHTML += `<div class="flex justify-between" style="color: var(--text-muted)"><span>Rundung</span><span class="num">‚àíCHF ${Math.round(rundung).toLocaleString('de-CH')}</span></div>`;
            }
            summaryEl.innerHTML = summaryHTML;

            // Total
            document.getElementById('config-total-price').textContent = formatCHF(total);
        }

        function submitConfigRequest() {
            if (!configState.unitId || !configState.line) {
                showToast('Bitte w√§hlen Sie zuerst eine Wohnung und Ausstattungslinie', 'error');
                return;
            }

            const unit = appData.units.find(u => u.id === configState.unitId);
            if (!unit) return;

            // Erstelle Zusammenfassung
            const totalPrice = document.getElementById('config-total-price').textContent;

            // Zeige Best√§tigungsmodal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 modal-backdrop';
            modal.innerHTML = `
                <div class="card rounded-xl p-6 max-w-md w-full mx-4 animate-fade-in text-center">
                    <div class="text-5xl mb-4">üè†</div>
                    <h3 class="text-xl font-bold mb-2">Reservationsanfrage</h3>
                    <p class="mb-4" style="color: var(--text-secondary)">
                        Sie m√∂chten <strong>${esc(unit.id)}</strong> reservieren.<br>
                        Gesamtpreis: <strong class="num">${totalPrice}</strong>
                    </p>
                    <div class="p-4 rounded-lg mb-4" style="background: var(--warning-light)">
                        <p class="text-sm"><strong>Reservationszahlung: CHF 40'000</strong></p>
                        <p class="text-xs mt-1" style="color: var(--text-muted)">Wird bei Vertragsunterzeichnung f√§llig</p>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="config-customer-name" placeholder="Ihr Name *" class="input-field w-full px-4 py-3 rounded-lg mb-2">
                        <input type="email" id="config-customer-email" placeholder="Ihre E-Mail *" class="input-field w-full px-4 py-3 rounded-lg mb-2">
                        <input type="tel" id="config-customer-phone" placeholder="Ihre Telefonnummer" class="input-field w-full px-4 py-3 rounded-lg">
                    </div>
                    <div class="flex gap-3">
                        <button class="cancel flex-1 px-4 py-3 rounded-lg btn-secondary">Abbrechen</button>
                        <button class="confirm flex-1 px-4 py-3 rounded-lg font-semibold" style="background: var(--premium); color: white">Anfrage senden</button>
                    </div>
                </div>
            `;
            modal.querySelector('.cancel').onclick = () => modal.remove();
            modal.querySelector('.confirm').onclick = () => {
                const name = document.getElementById('config-customer-name').value.trim();
                const email = document.getElementById('config-customer-email').value.trim();

                if (!name || !email) {
                    showToast('Bitte Name und E-Mail eingeben', 'error');
                    return;
                }

                modal.remove();
                showToast('Anfrage erfolgreich gesendet! Wir melden uns bei Ihnen. ‚úì');

                // Reset Konfigurator
                document.getElementById('config-unit-select').value = '';
                updateConfigurator();
            };
            document.body.appendChild(modal);
        }

        // ==================== AUTH FUNCTIONS ====================

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-username').focus();
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-form').reset();
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Anmelden...';
            errorEl.classList.add('hidden');

            try {
                await API.AuthAPI.login(username, password);
                closeLoginModal();
                updateAuthUI();
                showToast('Erfolgreich angemeldet ‚úì');
                await loadDataFromServer();
            } catch (err) {
                errorEl.textContent = err.message || 'Anmeldung fehlgeschlagen';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Anmelden';
            }
        }

        async function handleLogout() {
            await API.AuthAPI.logout();
            updateAuthUI();
            switchTab('configurator');
            showToast('Erfolgreich abgemeldet');
        }

        function updateAuthUI() {
            const isAuth = window.API && API.AuthState.isAuthenticated();
            const isAdmin = window.API && API.AuthState.isAdmin();
            const user = window.API ? API.AuthState.user : null;

            document.getElementById('auth-buttons-logged-out').classList.toggle('hidden', isAuth);
            document.getElementById('auth-buttons-logged-in').classList.toggle('hidden', !isAuth);

            if (user) {
                document.getElementById('current-user').textContent = (user.role === 'admin' ? 'üëë' : 'üë§') + ' ' + user.username;
            }

            document.querySelectorAll('.auth-required').forEach(el => {
                el.classList.toggle('hidden', !isAuth);
            });

            document.querySelectorAll('.admin-only').forEach(el => {
                if (isAuth && !isAdmin) el.classList.add('hidden');
            });

            const infoBox = document.getElementById('info-box');
            if (infoBox) infoBox.classList.toggle('hidden', !isAuth);

            if (!isAuth) switchTab('configurator');
        }

        async function loadDataFromServer() {
            if (!window.API || !API.AuthState.isAuthenticated()) return;
            try {
                const settings = await API.AdminAPI.getSettings();
                if (settings) {
                    appData = { ...appData, ...settings };
                    loadSettings();
                }
                const units = await API.AdminAPI.getUnits();
                if (units && units.length > 0) {
                    appData.units = units.map(u => ({
                        ...u.data, id: u.id,
                        buyer: u.buyer ? { name: u.buyer.name, line: u.buyer.line, costs: u.buyer.costs || {}, options: u.buyer.options || {}, zusatzparkplaetze: u.buyer.zusatzparkplaetze || 0, bastelraeume: u.buyer.bastelraeume || 0 } : null
                    }));
                    renderUnitsTable();
                    populateBuyerSelect();
                    populateConfigUnitSelect();
                }
                showToast('Daten vom Server geladen ‚úì');
            } catch (err) {
                console.error('Fehler beim Laden:', err);
            }
        }

        async function saveSettingsToServer() {
            if (!window.API || !API.AuthState.isAuthenticated()) return;
            try {
                await API.AdminAPI.saveSettings({
                    optionPrices: appData.optionPrices,
                    optionDescriptions: appData.optionDescriptions,
                    premiumBetreuung: appData.premiumBetreuung,
                    premiumElektro: appData.premiumElektro,
                    kostenprognose: appData.kostenprognose,
                    kulanzSchwelle: appData.kulanzSchwelle,
                    parkplatzPreis: appData.parkplatzPreis,
                    zusatzparkplatzPreis: appData.zusatzparkplatzPreis,
                    bastelraumPreis: appData.bastelraumPreis
                });
            } catch (err) { console.error('Fehler beim Speichern:', err); }
        }

        const originalSaveSettings = saveSettings;
        saveSettings = function() { originalSaveSettings(); saveSettingsToServer(); };

        window.addEventListener('auth:logout', () => updateAuthUI());

        // ==================== INIT ====================
        const apiScript = document.createElement('script');
        apiScript.src = 'api-client.js';
        apiScript.onload = () => {
            updateAuthUI();
            if (API.AuthState.isAuthenticated()) loadDataFromServer();
        };
        document.head.appendChild(apiScript);

        loadSettings();
        renderUnitsTable();
        populateConfigUnitSelect();
        switchTab('configurator');
    </script>


</body></html>